---------------------------------------------------------
-- Export file for user VTU@ORCL                       --
-- Created by mbeshr on 23/03/2021, 22:04:09 22:04:09  --
---------------------------------------------------------

set define off
spool ora_vtu_struc_202103232203.log

prompt
prompt Creating table ACTIVITIES
prompt =========================
prompt
create table ACTIVITIES
(
  act_id       VARCHAR2(100) not null,
  act_name     NVARCHAR2(200) not null,
  act_type     VARCHAR2(100) not null,
  act_order    NUMBER default 0 not null,
  internal_use NUMBER(1) default 0 not null,
  act_desc     NVARCHAR2(300)
)
;
alter table ACTIVITIES
  add constraint FK_ACTIVITIES primary key (ACT_ID);

prompt
prompt Creating table ACTIVITIES2
prompt ==========================
prompt
create table ACTIVITIES2
(
  act_id       VARCHAR2(100) not null,
  act_name     NVARCHAR2(200) not null,
  act_type     VARCHAR2(100) not null,
  act_order    NUMBER default 0 not null,
  internal_use NUMBER(1) default 0 not null,
  act_desc     NVARCHAR2(300)
)
;

prompt
prompt Creating table MESSAGE_TEMPLATE
prompt ===============================
prompt
create table MESSAGE_TEMPLATE
(
  msg_id       NUMBER not null,
  msg_name     NVARCHAR2(200) not null,
  msg_text     NVARCHAR2(500) not null,
  createdon    DATE default sysdate not null,
  createdby    VARCHAR2(9) not null,
  createdbyacc NUMBER not null,
  lastupdateon DATE,
  towho        NUMBER(1) default 1 not null
)
;
alter table MESSAGE_TEMPLATE
  add constraint PK_MESSAGE_TEMPLATE primary key (MSG_ID);

prompt
prompt Creating table ACTIVITY_MESSAGE
prompt ===============================
prompt
create table ACTIVITY_MESSAGE
(
  act_id       VARCHAR2(100) not null,
  msg_id       NUMBER not null,
  sending_time VARCHAR2(100) not null,
  createdon    DATE default sysdate not null,
  createdby    VARCHAR2(9) not null,
  createdbyacc NUMBER not null,
  msg_order    NUMBER default 1 not null
)
;
alter table ACTIVITY_MESSAGE
  add constraint PK_ACTIVITY_MESSAGE primary key (ACT_ID, MSG_ID);
alter table ACTIVITY_MESSAGE
  add constraint FK2_ACTIVITY_MESSAGE foreign key (MSG_ID)
  references MESSAGE_TEMPLATE (MSG_ID) on delete cascade;
alter table ACTIVITY_MESSAGE
  add constraint FK_ACTIVITY_MESSAGE foreign key (ACT_ID)
  references ACTIVITIES (ACT_ID) on delete cascade;

prompt
prompt Creating table APPROLE
prompt ======================
prompt
create table APPROLE
(
  roleid    NUMBER not null,
  rolename  NVARCHAR2(100) not null,
  isactive  NUMBER(1) default 1 not null,
  weight    NUMBER(3) default 0 not null,
  roleorder NUMBER(2) default 0 not null,
  rolecode  VARCHAR2(100)
)
;
alter table APPROLE
  add constraint PK_ROLE primary key (ROLEID);

prompt
prompt Creating table PARTNER_STATUS
prompt =============================
prompt
create table PARTNER_STATUS
(
  statusid   NUMBER not null,
  statusname NVARCHAR2(200)
)
;
alter table PARTNER_STATUS
  add constraint PK_PARTNER_STATUS primary key (STATUSID);

prompt
prompt Creating table CITY
prompt ===================
prompt
create table CITY
(
  cityid    NUMBER not null,
  cityname  NVARCHAR2(100) not null,
  cityorder NUMBER(2) default 0 not null
)
;
alter table CITY
  add constraint PK_CITY primary key (CITYID);

prompt
prompt Creating table IDTYPES
prompt ======================
prompt
create table IDTYPES
(
  idtypeid   NUMBER not null,
  idtypename NVARCHAR2(200),
  isactive   NUMBER(1) default 1 not null
)
;
alter table IDTYPES
  add constraint PK_IDTYPE primary key (IDTYPEID);

prompt
prompt Creating table PARTNER
prompt ======================
prompt
create table PARTNER
(
  partner_id           VARCHAR2(9) not null,
  partner_name         NVARCHAR2(200) not null,
  brandname            NVARCHAR2(200),
  balance              NUMBER(18,2) default 0 not null,
  reserved             NUMBER(18,2) default 0 not null,
  verificationcodenext NUMBER(1) default 1 not null,
  locktime             DATE,
  roleid               NUMBER not null,
  id_no                NVARCHAR2(150) not null,
  id_type              NUMBER not null,
  id_place             NVARCHAR2(200) not null,
  id_issued            DATE,
  status               NUMBER not null,
  statuson             DATE default sysdate,
  statusby             VARCHAR2(9),
  createdon            DATE default sysdate not null,
  createdby            VARCHAR2(9) not null,
  cityid               NUMBER not null,
  districtid           NUMBER not null,
  street               NVARCHAR2(150),
  zone                 NVARCHAR2(150),
  extra_address        NVARCHAR2(200),
  pair_mobile          VARCHAR2(9) not null,
  mobile               VARCHAR2(9),
  fixed                NVARCHAR2(30),
  fax                  NVARCHAR2(30),
  email                VARCHAR2(100),
  pwd                  VARCHAR2(200) not null,
  extra                VARCHAR2(200),
  wrong_pwd_attempts   NUMBER default 0 not null,
  last_login           DATE,
  ip_address           VARCHAR2(20),
  partner_acc          NUMBER not null,
  ref_partner          VARCHAR2(9)
)
;
create index IDX_PARTNER_ID on PARTNER (PARTNER_ID);
alter table PARTNER
  add constraint PK_PARTNER primary key (PARTNER_ACC);
alter table PARTNER
  add constraint FK_PARTNER_CITY foreign key (CITYID)
  references CITY (CITYID) on delete set null;
alter table PARTNER
  add constraint FK_PARTNER_IDTYPE foreign key (ID_TYPE)
  references IDTYPES (IDTYPEID) on delete set null;
alter table PARTNER
  add constraint FK_PARTNER_ROLE foreign key (ROLEID)
  references APPROLE (ROLEID) on delete set null;
alter table PARTNER
  add constraint FK_PARTNER_STATUS foreign key (STATUS)
  references PARTNER_STATUS (STATUSID) on delete set null;

prompt
prompt Creating table ADJUSTMENT
prompt =========================
prompt
create table ADJUSTMENT
(
  adj_id         NUMBER not null,
  createon       DATE default sysdate not null,
  createdby      VARCHAR2(9) not null,
  moneytranferid NUMBER not null,
  src_bal        NUMBER(18,2) default 0 not null,
  src_role_id    NUMBER not null,
  src_status     NUMBER not null,
  src_acc        NUMBER not null,
  dest_bal       NUMBER(18,2) default 0 not null,
  dest_role_id   NUMBER not null,
  dest_status    NUMBER not null,
  dest_acc       NUMBER not null,
  amount         NUMBER(18,2) default 0 not null,
  tax_per        NUMBER(4,2) default 0 not null,
  tax_amt        NUMBER(18,2) default 0 not null,
  bonus_per      NUMBER(4,2) default 0 not null,
  bonus_amt      NUMBER(18,2) default 0 not null,
  bonus_tax      NUMBER(4,2) default 0 not null,
  bonus_tax_amt  NUMBER(18,2) default 0 not null,
  received_amt   NUMBER(18,2) default 0 not null,
  net_amount     NUMBER(18,2) default 0 not null,
  access_channel VARCHAR2(100) not null,
  note           NVARCHAR2(300),
  period_days    NUMBER default 0 not null,
  createdbyacc   NUMBER default 0 not null,
  dest_id        VARCHAR2(9),
  src_id         VARCHAR2(9),
  sett_period    NUMBER default 0 not null,
  pfr            NUMBER default 0 not null
)
;
alter table ADJUSTMENT
  add constraint PK_ADJUSTEMENT primary key (ADJ_ID);
alter table ADJUSTMENT
  add constraint UQ_ADJUSTEMENT unique (MONEYTRANFERID);
alter table ADJUSTMENT
  add constraint FK1_ADJUSTEMENT foreign key (SRC_ACC)
  references PARTNER (PARTNER_ACC);
alter table ADJUSTMENT
  add constraint FK2_ADJUSTEMENT foreign key (DEST_ACC)
  references PARTNER (PARTNER_ACC);
alter table ADJUSTMENT
  add constraint FK3_ADJUSTEMENT foreign key (SRC_ROLE_ID)
  references APPROLE (ROLEID);
alter table ADJUSTMENT
  add constraint FK4_ADJUSTEMENT foreign key (DEST_ROLE_ID)
  references APPROLE (ROLEID);

prompt
prompt Creating table API_IP_BLACKLIST
prompt ===============================
prompt
create table API_IP_BLACKLIST
(
  ip_address VARCHAR2(15) not null,
  createdon  DATE default sysdate not null
)
;
alter table API_IP_BLACKLIST
  add constraint PK_API_IP_BLACKLIST primary key (IP_ADDRESS);

prompt
prompt Creating table API_LOG
prompt ======================
prompt
create table API_LOG
(
  log_id     NUMBER not null,
  createdon  DATE default sysdate,
  log_data   VARCHAR2(500),
  log_user   VARCHAR2(100),
  log_ip     VARCHAR2(50),
  log_level  NUMBER(1),
  log_action VARCHAR2(100)
)
;
alter table API_LOG
  add constraint PK_API_LOG primary key (LOG_ID);

prompt
prompt Creating table BG_SERVICE
prompt =========================
prompt
create table BG_SERVICE
(
  bg_id             NUMBER not null,
  createdon         DATE default sysdate not null,
  createdby         VARCHAR2(9) not null,
  createdbyacc      NUMBER not null,
  bg_source         VARCHAR2(100) not null,
  partner_id        VARCHAR2(9),
  partner_acc       NUMBER,
  start_date        DATE,
  end_date          DATE,
  record_count      NUMBER default 0 not null,
  file_name         VARCHAR2(200),
  file_location     VARCHAR2(200),
  status            VARCHAR2(100) not null,
  status_time       DATE default sysdate not null,
  duration_sec      NUMBER default 0 not null,
  note              VARCHAR2(300),
  active_time       DATE default sysdate not null,
  service_name      VARCHAR2(200) not null,
  file_size         NUMBER default 0 not null,
  actual_start_time DATE
)
;
alter table BG_SERVICE
  add constraint PK_BG_SERVICE primary key (BG_ID);

prompt
prompt Creating table COLLECTION
prompt =========================
prompt
create table COLLECTION
(
  cl_id          NUMBER not null,
  createdon      DATE default sysdate not null,
  subs_no        VARCHAR2(9) not null,
  amount         NUMBER(18,2) default 0 not null,
  pos_id         VARCHAR2(9) not null,
  pos_acc        NUMBER not null,
  pos_bal        NUMBER(18,2) not null,
  access_channel VARCHAR2(100) not null,
  status         NUMBER(1) default 0 not null,
  status_time    DATE,
  queue_no       NUMBER(2) default 1 not null,
  ref_no         VARCHAR2(100),
  ref_message    NVARCHAR2(500),
  ref_time       DATE,
  ref_trans_no   VARCHAR2(100),
  debug_info     NVARCHAR2(500),
  pfr            NUMBER default 0 not null,
  api_trans      NUMBER default 0 not null
)
;
alter table COLLECTION
  add constraint PK_COLLECTION primary key (CL_ID);

prompt
prompt Creating table COLLECTION_DRAFT
prompt ===============================
prompt
create table COLLECTION_DRAFT
(
  row_id         NUMBER not null,
  ref_no         NUMBER not null,
  queue_no       NUMBER(2) not null,
  access_channel VARCHAR2(100),
  createdon      DATE default sysdate not null
)
;
alter table COLLECTION_DRAFT
  add constraint PK_COLLECTION_DRAFT primary key (ROW_ID);
alter table COLLECTION_DRAFT
  add constraint UQ_COLLECTION_DRAFT unique (REF_NO);
alter table COLLECTION_DRAFT
  add constraint FK_COLLECTION_DRAFT foreign key (REF_NO)
  references COLLECTION (CL_ID) on delete cascade;

prompt
prompt Creating table COMMON_CODE
prompt ==========================
prompt
create table COMMON_CODE
(
  code_id    VARCHAR2(100) not null,
  code_name  NVARCHAR2(150),
  code_type  VARCHAR2(100) not null,
  code_order NUMBER(3)
)
;
alter table COMMON_CODE
  add constraint FK_COMMON_CODE primary key (CODE_ID, CODE_TYPE);

prompt
prompt Creating table CONFISCATION
prompt ===========================
prompt
create table CONFISCATION
(
  con_id       NUMBER not null,
  createdon    DATE default sysdate not null,
  createdby    VARCHAR2(9) not null,
  createdbyacc NUMBER not null,
  partner_id   VARCHAR2(9) not null,
  partner_acc  NUMBER not null,
  balance      NUMBER(18,2) default 0 not null,
  note         NVARCHAR2(200) not null,
  pfr          NUMBER default 0 not null
)
;
alter table CONFISCATION
  add constraint PK_CONFISCATION primary key (CON_ID);
alter table CONFISCATION
  add constraint FK1_CONFISCATION foreign key (CREATEDBYACC)
  references PARTNER (PARTNER_ACC);
alter table CONFISCATION
  add constraint FK2_CONFISCATION foreign key (PARTNER_ACC)
  references PARTNER (PARTNER_ACC);

prompt
prompt Creating table DATA_AUDIT
prompt =========================
prompt
create table DATA_AUDIT
(
  row_id      NUMBER not null,
  partner_id  VARCHAR2(9) not null,
  createdon   DATE default sysdate not null,
  act_id      VARCHAR2(100) not null,
  action_id   VARCHAR2(100) not null,
  note        NVARCHAR2(500),
  old_value   NVARCHAR2(2000),
  new_value   NVARCHAR2(2000),
  system_note VARCHAR2(1000),
  error       NVARCHAR2(2000),
  success     NUMBER(1) default 1 not null,
  partner_acc NUMBER
)
;
comment on column DATA_AUDIT.action_id
  is 'common_code.code_type = ''audit.action''';
alter table DATA_AUDIT
  add constraint FK_DATA_AUDIT primary key (ROW_ID);
alter table DATA_AUDIT
  add constraint FK2_DATA_AUDIT foreign key (ACT_ID)
  references ACTIVITIES (ACT_ID);

prompt
prompt Creating table DISTRICT
prompt =======================
prompt
create table DISTRICT
(
  disid    NUMBER not null,
  disname  NVARCHAR2(200) not null,
  disorder NUMBER(2) default 0 not null,
  cityid   NUMBER not null
)
;
alter table DISTRICT
  add constraint PK_DISTRICT primary key (DISID, CITYID);
alter table DISTRICT
  add constraint FK_DISTRICT_CITY foreign key (CITYID)
  references CITY (CITYID) on delete cascade;

prompt
prompt Creating table ERROR_LIST
prompt =========================
prompt
create table ERROR_LIST
(
  error_no   NUMBER,
  error_desc NVARCHAR2(200)
)
;

prompt
prompt Creating table EVENT
prompt ====================
prompt
create table EVENT
(
  event_id    VARCHAR2(100) not null,
  event_name  NVARCHAR2(200) not null,
  event_order NUMBER default 0 not null,
  createdon   DATE default sysdate not null
)
;
alter table EVENT
  add constraint PK_EVENT primary key (EVENT_ID);

prompt
prompt Creating table GLOGALSETTINGS
prompt =============================
prompt
create table GLOGALSETTINGS
(
  sett_code  VARCHAR2(150) not null,
  sett_value NVARCHAR2(200) not null,
  sett_name  NVARCHAR2(200) not null,
  sett_order NUMBER default 0 not null
)
;
alter table GLOGALSETTINGS
  add constraint PK_GLOGALSETTINGS primary key (SETT_CODE);

prompt
prompt Creating table MONEY_TRANSFER
prompt =============================
prompt
create table MONEY_TRANSFER
(
  trans_id        NUMBER not null,
  part_id         VARCHAR2(9) not null,
  part_role_id    NUMBER not null,
  part_bal        NUMBER(18,2) default 0 not null,
  pay_type        VARCHAR2(100) not null,
  pay_no          NVARCHAR2(100),
  pay_date        DATE,
  bank_name       NVARCHAR2(100),
  createdby       VARCHAR2(9) not null,
  createdon       DATE default sysdate not null,
  access_channel  VARCHAR2(100) not null,
  amount          NUMBER(18,2) default 0 not null,
  tax_per         NUMBER(4,2) default 0 not null,
  tax_amt         NUMBER(18,2) default 0 not null,
  bonus_per       NUMBER(4,2) default 0 not null,
  bonus_amt       NUMBER(18,2) default 0 not null,
  bonus_tax       NUMBER(4,2) default 0 not null,
  bonus_tax_amt   NUMBER(18,2) default 0 not null,
  received_amt    NUMBER(18,2) default 0 not null,
  net_amount      NUMBER(18,2) default 0 not null,
  bill_no         NVARCHAR2(100),
  request_no      NVARCHAR2(100),
  request_amt     NUMBER(18,2) default 0 not null,
  note            NVARCHAR2(300),
  adjusted        NUMBER(1) default 0 not null,
  adjust_id       NUMBER,
  creator_bal     NUMBER(18,2) default 0 not null,
  creator_role_id NUMBER not null,
  part_acc        NUMBER,
  creator_acc     NUMBER,
  pfr             NUMBER default 0 not null,
  api_trans       NUMBER default 0 not null
)
;
alter table MONEY_TRANSFER
  add constraint PK_MONEY_TRANSFER primary key (TRANS_ID);
alter table MONEY_TRANSFER
  add constraint FK1_MONEY_TRANSFER foreign key (PART_ROLE_ID)
  references APPROLE (ROLEID);
alter table MONEY_TRANSFER
  add constraint FK2_MONEY_TRANSFER foreign key (PART_ACC)
  references PARTNER (PARTNER_ACC);
alter table MONEY_TRANSFER
  add constraint FK3_MONEY_TRANSFER foreign key (CREATOR_ACC)
  references PARTNER (PARTNER_ACC);

prompt
prompt Creating table MSG_DICTIONARY
prompt =============================
prompt
create table MSG_DICTIONARY
(
  word_id    VARCHAR2(100) not null,
  word_name  NVARCHAR2(100) not null,
  word_order NUMBER default 1 not null,
  obj_member VARCHAR2(200)
)
;
alter table MSG_DICTIONARY
  add constraint PK_MESSAGE_WORDS primary key (WORD_ID);

prompt
prompt Creating table NOTIFICATION
prompt ===========================
prompt
create table NOTIFICATION
(
  nf_id       NUMBER not null,
  createdon   DATE default sysdate not null,
  partner_id  VARCHAR2(9) not null,
  partner_acc NUMBER not null,
  notify_msg  NVARCHAR2(400) not null,
  act_id      VARCHAR2(100) not null,
  ref_no      NUMBER not null
)
;
alter table NOTIFICATION
  add constraint PK_NOTIFICATION primary key (NF_ID);

prompt
prompt Creating table OPERATION_EXCEPTION
prompt ==================================
prompt
create table OPERATION_EXCEPTION
(
  exp_id        NUMBER not null,
  exp_code      NUMBER,
  exp_message   NVARCHAR2(2000),
  exp_date      DATE default sysdate not null,
  exp_operation VARCHAR2(100),
  exp_object    VARCHAR2(100)
)
;
alter table OPERATION_EXCEPTION
  add constraint PK_OPERATION_EXCEPTION primary key (EXP_ID);

prompt
prompt Creating table PARTNER_ACTIVITY
prompt ===============================
prompt
create table PARTNER_ACTIVITY
(
  row_id           NUMBER not null,
  act_id           VARCHAR2(100) not null,
  fromroleid       NUMBER not null,
  queryduration    VARCHAR2(50) not null,
  act_scope        VARCHAR2(50) not null,
  maxrec           NUMBER default 0 not null,
  onlypartchildren NUMBER(1) default 0 not null,
  createdon        DATE default sysdate not null,
  createdby        VARCHAR2(9) not null,
  lastediton       DATE default sysdate not null,
  createdbyacc     NUMBER default 0 not null
)
;
alter table PARTNER_ACTIVITY
  add constraint PK_PARTNER_ACTIVITY primary key (ROW_ID);
alter table PARTNER_ACTIVITY
  add constraint UQ_PARTNER_ACTIVITY unique (ACT_ID, FROMROLEID);
alter table PARTNER_ACTIVITY
  add constraint FK1_PARTNER_ACTIVITY foreign key (ACT_ID)
  references ACTIVITIES (ACT_ID) on delete cascade;
alter table PARTNER_ACTIVITY
  add constraint FK2_PARTNER_ACTIVITY foreign key (FROMROLEID)
  references APPROLE (ROLEID);

prompt
prompt Creating table PARTNER_ACTIVITY_DETAIL
prompt ======================================
prompt
create table PARTNER_ACTIVITY_DETAIL
(
  row_id       NUMBER not null,
  master_row   NUMBER not null,
  dest_role_id NUMBER not null,
  check_bal    NUMBER(1) default 1 not null,
  max_value    NUMBER(18,2) default 0 not null,
  min_value    NUMBER(18,2) default 0 not null,
  bonus_per    NUMBER(4,2) default 0 not null,
  taxper       NUMBER(4,2) default 0 not null,
  bonus_tax    NUMBER(4,2) default 0 not null,
  createdon    DATE default sysdate not null,
  createdby    VARCHAR2(9) not null,
  lastediton   DATE default sysdate not null,
  createdbyacc NUMBER default 0 not null
)
;
alter table PARTNER_ACTIVITY_DETAIL
  add constraint PK_PARTNER_ACTIVITY_DETAIL primary key (ROW_ID, MASTER_ROW);
alter table PARTNER_ACTIVITY_DETAIL
  add constraint UQ_PARTNER_ACTIVITY_DETAIL unique (MASTER_ROW, DEST_ROLE_ID);
alter table PARTNER_ACTIVITY_DETAIL
  add constraint FK1_PARTNER_ACTIVITY_DETAIL foreign key (MASTER_ROW)
  references PARTNER_ACTIVITY (ROW_ID) on delete cascade;
alter table PARTNER_ACTIVITY_DETAIL
  add constraint FK2_PARTNER_ACTIVITY_DETAIL foreign key (DEST_ROLE_ID)
  references APPROLE (ROLEID);

prompt
prompt Creating table PARTNER_REQUEST
prompt ==============================
prompt
create table PARTNER_REQUEST
(
  req_row_no       NUMBER not null,
  createdon        DATE default sysdate not null,
  req_id           NUMBER not null,
  req_content      NVARCHAR2(200) not null,
  replay_time      DATE,
  replay_desc      NVARCHAR2(200),
  replay_shortcode VARCHAR2(10),
  status           NUMBER default 0 not null,
  queue_no         NUMBER(2) default 1 not null,
  error            NVARCHAR2(300),
  accesschannel    VARCHAR2(100)
)
;
alter table PARTNER_REQUEST
  add constraint PK_PARTNER_REQUEST primary key (REQ_ROW_NO);

prompt
prompt Creating table PARTNER_STATUS_LOG
prompt =================================
prompt
create table PARTNER_STATUS_LOG
(
  log_id             NUMBER not null,
  createdon          DATE default sysdate not null,
  createdby          VARCHAR2(9) not null,
  createdbyacc       NUMBER not null,
  partner_id         VARCHAR2(9) not null,
  partner_acc        NUMBER not null,
  old_status         NUMBER not null,
  new_status         NUMBER not null,
  note               NVARCHAR2(400) not null,
  newstatus_expireon DATE
)
;
alter table PARTNER_STATUS_LOG
  add constraint PK_PARTNER_STATUS_LOG primary key (LOG_ID);
alter table PARTNER_STATUS_LOG
  add constraint FK2_PARTNER_STATUS_LOG foreign key (PARTNER_ACC)
  references PARTNER (PARTNER_ACC);
alter table PARTNER_STATUS_LOG
  add constraint FK_PARTNER_STATUS_LOG foreign key (CREATEDBYACC)
  references PARTNER (PARTNER_ACC);

prompt
prompt Creating table PFINREC
prompt ======================
prompt
create table PFINREC
(
  pfr_id       NUMBER not null,
  createdon    DATE default sysdate not null,
  partner_acc  NUMBER not null,
  amount       NUMBER(18,2) default 0 not null,
  act_id       VARCHAR2(100) not null,
  act_no       NUMBER not null,
  createdbyacc NUMBER,
  act_time     DATE not null
)
;
comment on column PFINREC.act_no
  is 'trans no (sequenece)';
create index IDX_PFINREC_PARTNER_ACC on PFINREC (PARTNER_ACC);
alter table PFINREC
  add constraint PK_PFINREC primary key (PFR_ID);

prompt
prompt Creating table PFR_ONLINE
prompt =========================
prompt
create table PFR_ONLINE
(
  bal           NUMBER default 0 not null,
  pfr_id        NUMBER not null,
  createdon     DATE,
  partner_acc   NUMBER not null,
  partner_id    VARCHAR2(9),
  amount        NUMBER(18,2) default 0 not null,
  act_id        VARCHAR2(100),
  act_name      NVARCHAR2(200),
  act_no        NUMBER,
  createdbyacc  NUMBER,
  creatorbyid   VARCHAR2(9),
  creatorbyname NVARCHAR2(200),
  act_time      DATE,
  generatedon   DATE default sysdate not null
)
;
create index INDX_PARTNER_ACC on PFR_ONLINE (PARTNER_ACC);

prompt
prompt Creating table REQUEST
prompt ======================
prompt
create table REQUEST
(
  req_id   NUMBER not null,
  req_name NVARCHAR2(200)
)
;
alter table REQUEST
  add constraint PK_REQUEST primary key (REQ_ID);

prompt
prompt Creating table SEND_SMSONE_HIS
prompt ==============================
prompt
create table SEND_SMSONE_HIS
(
  sms_id       NUMBER not null,
  createdon    DATE default sysdate not null,
  createdby    VARCHAR2(9) not null,
  createdbyacc NUMBER not null,
  receiver     VARCHAR2(9) not null,
  shortcode    VARCHAR2(10) not null,
  msg          NVARCHAR2(200) not null,
  note         NVARCHAR2(200)
)
;
alter table SEND_SMSONE_HIS
  add constraint PK_SEND_SMSONE_HIS primary key (SMS_ID);
alter table SEND_SMSONE_HIS
  add constraint FK_SEND_SMSONE_HIS foreign key (CREATEDBYACC)
  references PARTNER (PARTNER_ACC);

prompt
prompt Creating table SMS_IN
prompt =====================
prompt
create table SMS_IN
(
  in_no     NUMBER not null,
  reciever  VARCHAR2(9),
  sender    VARCHAR2(9),
  message   NVARCHAR2(300),
  createdon DATE default sysdate not null,
  ref_no    NUMBER,
  lang      VARCHAR2(10)
)
;
alter table SMS_IN
  add constraint PK_SMS_IN primary key (IN_NO);

prompt
prompt Creating table SMS_OUT
prompt ======================
prompt
create table SMS_OUT
(
  row_id    NUMBER not null,
  sender    VARCHAR2(9) not null,
  message   NVARCHAR2(300) not null,
  receiver  VARCHAR2(9) not null,
  createdon DATE default sysdate not null
)
;
alter table SMS_OUT
  add constraint PK_SMS_OUT primary key (ROW_ID);

prompt
prompt Creating table SMS_OUT_BAK
prompt ==========================
prompt
create table SMS_OUT_BAK
(
  row_id    NUMBER not null,
  sender    VARCHAR2(9) not null,
  message   NVARCHAR2(300) not null,
  receiver  VARCHAR2(9) not null,
  createdon DATE not null,
  backedon  DATE default sysdate not null
)
;
create index IDX_SMS_OUT_BAK on SMS_OUT_BAK (RECEIVER);

prompt
prompt Creating table SYS_ITEM
prompt =======================
prompt
create table SYS_ITEM
(
  item_id    VARCHAR2(100) not null,
  item_name  NVARCHAR2(100) not null,
  item_order NUMBER default 0 not null,
  createdon  DATE default sysdate not null
)
;
alter table SYS_ITEM
  add constraint PK_SYS_ITEM primary key (ITEM_ID);

prompt
prompt Creating table SYS_SUBITEM
prompt ==========================
prompt
create table SYS_SUBITEM
(
  item_id       VARCHAR2(100) not null,
  subitem_id    VARCHAR2(100) not null,
  subitem_name  NVARCHAR2(100) not null,
  subitem_order NUMBER default 0 not null,
  createdon     DATE default sysdate not null
)
;
alter table SYS_SUBITEM
  add constraint PK_SYS_SUBITEM primary key (ITEM_ID, SUBITEM_ID);
alter table SYS_SUBITEM
  add constraint FK_SYS_SUBITEM foreign key (ITEM_ID)
  references SYS_ITEM (ITEM_ID) on delete cascade;

prompt
prompt Creating table TMP_LOG
prompt ======================
prompt
create table TMP_LOG
(
  log_time DATE default sysdate not null,
  log      NVARCHAR2(500),
  act      VARCHAR2(200),
  log_id   NUMBER
)
;

prompt
prompt Creating table USERS_INSTRUCT
prompt =============================
prompt
create table USERS_INSTRUCT
(
  ins_id       NUMBER not null,
  createdon    DATE default sysdate not null,
  content      NVARCHAR2(300) not null,
  priority     VARCHAR2(100) not null,
  status       VARCHAR2(100) not null,
  status_time  DATE not null,
  createdbyid  VARCHAR2(9) not null,
  createdbyacc NUMBER not null,
  expire_time  DATE,
  subject      NVARCHAR2(300) not null
)
;
alter table USERS_INSTRUCT
  add constraint PK_USERS_INSTRUCT primary key (INS_ID);

prompt
prompt Creating table USERS_INSTRUCT_HIS
prompt =================================
prompt
create table USERS_INSTRUCT_HIS
(
  his_id       NUMBER not null,
  ins_id       NUMBER not null,
  partner_id   NUMBER not null,
  content      NVARCHAR2(300) not null,
  priority     VARCHAR2(100) not null,
  status       VARCHAR2(100) not null,
  status_time  DATE not null,
  createdbyid  VARCHAR2(9) not null,
  createdbyacc NUMBER not null,
  expire_time  DATE not null,
  createdon    DATE not null,
  historyon    DATE default sysdate not null,
  partner_acc  NUMBER,
  subject      NVARCHAR2(300) not null
)
;
alter table USERS_INSTRUCT_HIS
  add constraint PK_USERS_INSTRUCT_HIS primary key (HIS_ID);
alter table USERS_INSTRUCT_HIS
  add constraint FK1_USERS_INSTRUCT_HIS foreign key (INS_ID)
  references USERS_INSTRUCT (INS_ID) on delete cascade;

prompt
prompt Creating table USERS_INSTRUCT_TO
prompt ================================
prompt
create table USERS_INSTRUCT_TO
(
  to_id   NUMBER not null,
  ins_id  NUMBER not null,
  role_id NUMBER not null
)
;
alter table USERS_INSTRUCT_TO
  add constraint PK_USERS_INSTRUCT_TO primary key (TO_ID, INS_ID, ROLE_ID);
alter table USERS_INSTRUCT_TO
  add constraint FK_USERS_INSTRUCT_TO foreign key (INS_ID)
  references USERS_INSTRUCT (INS_ID) on delete cascade;

prompt
prompt Creating sequence SEQ_ADJUSTEMENT_ID
prompt ====================================
prompt
create sequence SEQ_ADJUSTEMENT_ID
minvalue 1
maxvalue 9999999999999999999999999999
start with 21
increment by 1
cache 20;

prompt
prompt Creating sequence SEQ_API_LOG
prompt =============================
prompt
create sequence SEQ_API_LOG
minvalue 1
maxvalue 9999999999999999999999999999
start with 21
increment by 1
cache 20;

prompt
prompt Creating sequence SEQ_BDSERVICE_ID
prompt ==================================
prompt
create sequence SEQ_BDSERVICE_ID
minvalue 1
maxvalue 9999999999999999999999999999
start with 21
increment by 1
cache 20;

prompt
prompt Creating sequence SEQ_CITY_ID
prompt =============================
prompt
create sequence SEQ_CITY_ID
minvalue 1
maxvalue 9999999999999999999999999999
start with 41
increment by 1
cache 20;

prompt
prompt Creating sequence SEQ_COLLECTION_DRAFT_ID
prompt =========================================
prompt
create sequence SEQ_COLLECTION_DRAFT_ID
minvalue 1
maxvalue 9999999999999999999999999999
start with 61
increment by 1
cache 20;

prompt
prompt Creating sequence SEQ_COLLECTION_ID
prompt ===================================
prompt
create sequence SEQ_COLLECTION_ID
minvalue 1
maxvalue 9999999999999999999999999999
start with 81
increment by 1
cache 20;

prompt
prompt Creating sequence SEQ_CONFISCATION_ID
prompt =====================================
prompt
create sequence SEQ_CONFISCATION_ID
minvalue 1
maxvalue 9999999999999999999999999999
start with 21
increment by 1
cache 20;

prompt
prompt Creating sequence SEQ_DATA_AUDIT_ID
prompt ===================================
prompt
create sequence SEQ_DATA_AUDIT_ID
minvalue 1
maxvalue 9999999999999999999999999999
start with 141
increment by 1
cache 20;

prompt
prompt Creating sequence SEQ_DISTRICT_ID
prompt =================================
prompt
create sequence SEQ_DISTRICT_ID
minvalue 1
maxvalue 9999999999999999999999999999
start with 341
increment by 1
cache 20;

prompt
prompt Creating sequence SEQ_EXCEPTION_ID
prompt ==================================
prompt
create sequence SEQ_EXCEPTION_ID
minvalue 1
maxvalue 9999999999999999999999999999
start with 181
increment by 1
cache 20;

prompt
prompt Creating sequence SEQ_MONEY_TRANSFER_ID
prompt =======================================
prompt
create sequence SEQ_MONEY_TRANSFER_ID
minvalue 1
maxvalue 9999999999999999999999999999
start with 241
increment by 1
cache 20;

prompt
prompt Creating sequence SEQ_NOTIFICATION_ID
prompt =====================================
prompt
create sequence SEQ_NOTIFICATION_ID
minvalue 1
maxvalue 9999999999999999999999999999
start with 41
increment by 1
cache 20;

prompt
prompt Creating sequence SEQ_PARTNER_ACC
prompt =================================
prompt
create sequence SEQ_PARTNER_ACC
minvalue 1
maxvalue 9999999999999999999999999999
start with 41
increment by 1
cache 20;

prompt
prompt Creating sequence SEQ_PARTNER_ACIVITY_ROWID
prompt ===========================================
prompt
create sequence SEQ_PARTNER_ACIVITY_ROWID
minvalue 1
maxvalue 9999999999999999999999999999
start with 341
increment by 1
cache 20;

prompt
prompt Creating sequence SEQ_PARTNER_REQ_ID
prompt ====================================
prompt
create sequence SEQ_PARTNER_REQ_ID
minvalue 1
maxvalue 9999999999999999999999999999
start with 81
increment by 1
cache 20;

prompt
prompt Creating sequence SEQ_PARTNER_STATUS_LOG_ID
prompt ===========================================
prompt
create sequence SEQ_PARTNER_STATUS_LOG_ID
minvalue 1
maxvalue 9999999999999999999999999999
start with 21
increment by 1
cache 20;

prompt
prompt Creating sequence SEQ_PFR_ID
prompt ============================
prompt
create sequence SEQ_PFR_ID
minvalue 1
maxvalue 9999999999999999999999999999
start with 161
increment by 1
cache 20;

prompt
prompt Creating sequence SEQ_ROLE_ID
prompt =============================
prompt
create sequence SEQ_ROLE_ID
minvalue 1
maxvalue 9999999999999999999999999999
start with 21
increment by 1
cache 20;

prompt
prompt Creating sequence SEQ_SMSONE_ID
prompt ===============================
prompt
create sequence SEQ_SMSONE_ID
minvalue 1
maxvalue 9999999999999999999999999999
start with 21
increment by 1
cache 20;

prompt
prompt Creating sequence SEQ_SMS_IN_ID
prompt ===============================
prompt
create sequence SEQ_SMS_IN_ID
minvalue 1
maxvalue 9999999999999999999999999999
start with 161
increment by 1
cache 20;

prompt
prompt Creating sequence SEQ_SMS_OUT_ID
prompt ================================
prompt
create sequence SEQ_SMS_OUT_ID
minvalue 1
maxvalue 9999999999999999999999999999
start with 381
increment by 1
cache 20;

prompt
prompt Creating sequence SEQ_TMP_LOG_ID
prompt ================================
prompt
create sequence SEQ_TMP_LOG_ID
minvalue 1
maxvalue 9999999999999999999999999999
start with 121
increment by 1
cache 20;

prompt
prompt Creating sequence SEQ_USERS_INSTRUCT_HIS_ID
prompt ===========================================
prompt
create sequence SEQ_USERS_INSTRUCT_HIS_ID
minvalue 1
maxvalue 9999999999999999999999999999
start with 61
increment by 1
cache 20;

prompt
prompt Creating sequence SEQ_USER_INST_ID
prompt ==================================
prompt
create sequence SEQ_USER_INST_ID
minvalue 1
maxvalue 9999999999999999999999999999
start with 81
increment by 1
cache 20;

prompt
prompt Creating view V_ADJUSTMENT
prompt ==========================
prompt
create or replace force view v_adjustment as
select
ad.adj_id,
ad.createon,
ad.createdby,
ad.createdbyacc,
creator.partner_name creator_name,
ad.moneytranferid,
ad.src_bal,
ad.src_role_id,
srcrole.rolename src_role_name,
ad.src_status,
(select ps.statusname from partner_status ps where ps.statusid = ad.src_status) src_status_name,
ad.src_acc,
src.partner_name src_name,
ad.src_id ,
ad.dest_bal,
ad.dest_role_id,
destrole.rolename dest_role_name,
ad.dest_status,
(select ps.statusname from partner_status ps where ps.statusid = ad.dest_status) dest_status_name,
ad.dest_acc,
dest.partner_name dest_name,
ad.dest_id,
ad.amount,
ad.tax_per,
ad.tax_amt,
ad.bonus_per,
ad.bonus_amt,
ad.bonus_tax,
ad.bonus_tax_amt,
ad.received_amt,
ad.net_amount,
ad.access_channel,
(select code_name from common_code where code_id = ad.access_channel and code_type = 'access.channel') access_channel_name,
ad.note,
ad.period_days,
ad.sett_period


from adjustment ad, partner creator, partner src, partner dest, approle srcrole, approle destrole
where ad.createdbyacc = creator.partner_acc
and ad.src_acc = src.partner_acc
and ad.dest_acc = dest.partner_acc
and ad.src_role_id = srcrole.roleid
and ad.dest_role_id = destrole.roleid;

prompt
prompt Creating view V_BG_SERVICE
prompt ==========================
prompt
create or replace force view v_bg_service as
select
bg.bg_id,
bg.createdon,
bg.createdby,
bg.createdbyacc,
creator.partner_name createdby_name,
bg.bg_source,
(select c.code_name from common_code c where c.code_type = 'bg_service_source' and c.code_id = bg.bg_source) bg_source_name,
bg.partner_id,
bg.partner_acc,
(select p.partner_name from partner p where p.partner_acc = bg.partner_acc) partner_name,
bg.start_date,
bg.end_date,
bg.record_count,
bg.file_name,
bg.file_location,
bg.status,
(select c.code_name from common_code c where c.code_type = 'bg_service_status' and c.code_id = bg.status) status_name,
bg.status_time,
bg.duration_sec,
bg.note,
bg.active_time,
bg.service_name,
bg.file_size,
bg.actual_start_time
from bg_service bg, partner creator
where bg.createdbyacc = creator.partner_acc;

prompt
prompt Creating view V_COLLECTION
prompt ==========================
prompt
create or replace force view v_collection as
select
c.cl_id,
c.createdon,
c.subs_no,
c.amount,
c.pos_id,
c.pos_acc,
c.pos_bal,
p.balance current_balance,
p.reserved current_reserved,
p.partner_name pos_name,
p.roleid pos_role_id,
(select approle.rolename from  approle  where approle.roleid = p.roleid) pos_role_name,
c.access_channel,
(select code_name from common_code code1 where code1.code_type='access.channel' and code1.code_id = c.access_channel) access_channel_name,
c.status,
(select code_name from common_code code1 where code1.code_type='Collection.Status' and code1.code_id = c.status) status_name,
c.status_time,
c.queue_no,
c.ref_no,
c.ref_message,
c.ref_time,
c.ref_trans_no,
c.debug_info,
c.api_trans
from collection c, partner p
where c.pos_acc = p.partner_acc;

prompt
prompt Creating view V_DATA_AUDIT
prompt ==========================
prompt
create or replace force view v_data_audit as
select
d.row_id,
d.partner_id,
p.partner_name,
d.createdon,
d.act_id,
d.action_id,
d.note,
d.old_value,
d.new_value,
d.system_note,
d.error,
d.success ,
d.partner_acc,
act.act_name,
act.act_type,
act.act_order,
act.internal_use,

c.code_name action_name,
c.code_type ,
c.code_order
from data_audit d, partner p, activities act, common_code c
where d.partner_id = p.partner_id
and d.act_id = act.act_id
and d.action_id = c.code_id
and c.code_type =  'audit.action';

prompt
prompt Creating view V_MONEY_TRANSFER
prompt ==============================
prompt
create or replace force view v_money_transfer as
select
tr.trans_id,
tr.part_id,
p.partner_name part_name,
tr.part_role_id,
prole.rolename part_role_name,
tr.part_bal,
tr.pay_type,
(select code_name from common_code code1 where code1.code_type='pay.type' and code1.code_id = tr.pay_type) pay_type_name,
tr.pay_no,
tr.pay_date,
tr.bank_name,
tr.createdby,
creator.partner_name creator_name,
tr.createdon,
tr.access_channel,
(select code_name from common_code code1 where code1.code_type='access.channel' and code1.code_id = tr.access_channel) access_channel_name,
tr.amount,
tr.tax_per,
tr.tax_amt,
tr.bonus_per,
tr.bonus_amt,
tr.bonus_tax,
tr.bonus_tax_amt,
tr.received_amt,
tr.net_amount,
tr.bill_no,
tr.request_no,
tr.request_amt,
tr.note,
tr.adjusted,
tr.adjust_id,
tr.creator_bal,
tr.creator_role_id,
crole.rolename creator_role_name,
tr.part_acc,
tr.creator_acc,
tr.api_trans
from money_transfer tr, partner p, partner creator, approle prole, approle crole
where tr.part_acc = p.partner_acc
and tr.creator_acc = creator.partner_acc
and tr.part_role_id = prole.roleid
and tr.creator_role_id = crole.roleid;

prompt
prompt Creating view V_PARTNER
prompt =======================
prompt
create or replace force view v_partner as
select
partner_id,
partner_name,
brandname,
balance,
reserved,
verificationcodenext,
locktime,
partner.roleid,
approle.rolename role_name,
id_no,
id_type,
(select  idtypes.idtypename from idtypes where idtypes.idtypeid = id_type) id_type_name,
id_place,
id_issued,
status,
ps.statusname status_name,
statuson,
statusby,
(select p.partner_name from partner p where p.partner_id = partner.statusby) statusby_name,
createdon,
createdby,
(select p2.partner_name from partner p2 where p2.partner_id = partner.createdby) createdby_name,
cityid,
(select city.cityname  from city where city.cityid = partner.cityid) city_name,
districtid,
(select district.disname  from district where district.disid = partner.districtid) district_name,
street,
zone,
extra_address,
pair_mobile,
mobile, fixed,
fax,
email,
wrong_pwd_attempts,
last_login,
ip_address,
partner_acc,
ref_partner ,
partner.pwd,
partner.extra,
(select p3.partner_name from partner p3 where p3.partner_id = partner.ref_partner) ref_partner_name
from partner, approle, partner_status ps

where partner.roleid = approle.roleid
and partner.status = ps.statusid;

prompt
prompt Creating view V_PARTNER_ACTIVITY
prompt ================================
prompt
create or replace force view v_partner_activity as
Select
part.row_id,
part.act_id,
part.fromroleid,

part.queryduration,
(select code_name from common_code code1 where code1.code_id = part.queryduration and code_type = 'queryduration') queryduration_name,
part.act_scope,
(select code_name from common_code code2 where code2.code_id = part.act_scope and code_type = 'activity.scope') act_scope_name,
part.maxrec,
part.onlypartchildren,
part.createdon,
part.createdby,
part.createdbyacc,
p.partner_name createdname,
part.lastediton,
act.act_name,
act.act_type,
act.act_order,
act.internal_use,
r1.rolename fromrolename,
r1.isactive fromroleisactive,
r1.weight fromroleweight,
r1.roleorder fromroleorder,
r1.rolecode fromordercode,
(select nvl(count(*), 0) from partner_activity_detail partdetail where partdetail.master_row = part.row_id) DetailCount
 from partner_activity part,
 activities act,
 approle r1,
 partner p
 where part.act_id = act.act_id
 and part.fromroleid = r1.roleid
  and part.createdbyacc = p.partner_acc;

prompt
prompt Creating view V_PARTNER_ACTIVITY_DETAIL
prompt =======================================
prompt
create or replace force view v_partner_activity_detail as
Select
part.row_id,
part.act_id,
part.fromroleid,
partdetail.row_id detail_row_id,
partdetail.master_row,
partdetail.dest_role_id toroleid,
partdetail.check_bal,
partdetail.max_value,
partdetail.min_value,
partdetail.bonus_per,
partdetail.taxper,
partdetail.bonus_tax,
part.queryduration,
(select code_name from common_code code1 where code1.code_id = part.queryduration and code_type = 'queryduration') queryduration_name,
part.act_scope,
(select code_name from common_code code2 where code2.code_id = part.act_scope and code_type = 'activity.scope') act_scope_name,
part.maxrec,
part.onlypartchildren,
part.createdon,
part.createdby,
part.createdbyacc,
p.partner_name createdname,
part.lastediton,
act.act_name,
act.act_type,
act.act_order,
act.internal_use,
r1.rolename fromrolename,
r1.isactive fromroleisactive,
r1.weight fromroleweight,
r1.roleorder fromroleorder,
r1.rolecode fromordercode,
r2.rolename torolename,
r2.isactive toroleisactive,
r2.weight toroleweight,
r2.roleorder toroleorder,
r2.rolecode torolecode
 from partner_activity part,
 partner_activity_detail partdetail,
 activities act,
 approle r1,
 approle r2,
 partner p
 where part.row_id = partdetail.master_row
 and part.act_id = act.act_id
 and part.fromroleid = r1.roleid
  and partdetail.dest_role_id = r2.roleid
  and part.createdby = p.partner_id;

prompt
prompt Creating view V_PENDING_RECHARGE_REQ
prompt ====================================
prompt
create or replace force view v_pending_recharge_req as
select
d.row_id,
d.queue_no,
d.access_channel,
d.createdon dcreatedon ,

c.cl_id,
c.createdon,
c.subs_no,
c.amount,
c.pos_id,
c.pos_acc,
c.pos_bal,
c.status,
c.status_time,
c.ref_no,
c.ref_message,
c.ref_time,
c.ref_trans_no,
c.debug_info

from collection_draft d, collection c
where d.ref_no = c.cl_id
order by d.row_id;

prompt
prompt Creating package PK_FINANCIAL
prompt =============================
prompt
create or replace package pk_financial is

  -- Public type declarations


  -- Public constant declarations
  --<ConstantName> constant <Datatype> := <Value>;

  -- Public variable declarations
  --<VariableName> <Datatype>;

  -- Public function and procedure declarations
  function fn_MoneyTransfer(
    v_part_id money_transfer.part_id%type,
    v_pay_type money_transfer.pay_type%type,
    v_pay_no money_transfer.pay_no%type,
    v_pay_date money_transfer.pay_date%type,
    v_bank_name money_transfer.bank_name%type,
    v_createdby money_transfer.createdby%type,
    v_access_channel money_transfer.access_channel%type,
    v_amount money_transfer.amount%type,
    v_bill_no money_transfer.bill_no%type,
    v_request_no money_transfer.request_no%type,
    v_request_amt money_transfer.request_amt%type,
    v_note money_transfer.note%type,
    v_api_trans money_transfer.api_trans%type
    ) return number;


function fn_Create_Adjustment (
v_createdby      adjustment.createdby%type, 
v_moneytranferid adjustment.moneytranferid%type, 
v_amount         adjustment.amount%type, 
v_access_channel adjustment.access_channel%type, 
v_note           adjustment.note%type,
v_createdbyacc      adjustment.createdbyacc%type
) return number;


function fn_Create_Collection (
v_subs_no          collection.subs_no%type, 
v_amount           collection.amount%type, 
v_pos_id           collection.pos_id%type, 
v_access_channel   collection.access_channel%type,
v_queue_no         collection.queue_no%type,
v_ref_no           collection.ref_no%type, 
v_ref_message      collection.ref_message%type,  
v_ref_time         collection.ref_time%type,  
v_ref_trans_no     collection.ref_trans_no%type,  
v_debug_info       collection.debug_info%type,
v_status       collection.status%type,
v_api_trans       collection.api_trans%type
) return number;

function fn_Update_Collection (
v_cl_id            collection.cl_id%type,
v_status         collection.status%type,
v_ref_no           collection.ref_no%type, 
v_ref_message      collection.ref_message%type,  
v_ref_time         collection.ref_time%type,  
v_ref_trans_no     collection.ref_trans_no%type,  
v_debug_info       collection.debug_info%type,
v_update_bal  number
) return number;

function fn_Create_Confiscation(
v_createdby    confiscation.createdby%type,     
v_createdbyacc confiscation.createdbyacc%type,
v_partner_id   confiscation.partner_id%type,  
v_partner_acc  confiscation.partner_acc%type,   
v_note         confiscation.note%type        ) return number;

function fn_BalanceOfPointOfTime(
  account number , 
  specificTime date 
  ) return number ;
  
  function fn_Generate_PFR(
    account number,
    startDate date,
    endDate date) return number;
end pk_financial;
/

prompt
prompt Creating view V_PFR
prompt ===================
prompt
create or replace force view v_pfr as
select
pk_financial.fn_balanceofpointoftime(pfr.partner_acc,  pfr.createdon) bal,
pfr.pfr_id,
pfr.createdon,
pfr.partner_acc,
p.partner_id,
pfr.amount,
pfr.act_id,
act.act_name,
pfr.act_no,
pfr.createdbyacc,
(select partner_id from partner p where p.partner_acc = pfr.createdbyacc) creatorbyid ,
(select partner_name from partner p where p.partner_acc = pfr.createdbyacc) creatorbyname ,
pfr.act_time
from pfinrec pfr, partner p, activities act
where pfr.partner_acc = p.partner_acc
and pfr.act_id = act.act_id;

prompt
prompt Creating view V_SMSOUT
prompt ======================
prompt
create or replace force view v_smsout as
select row_id, sender, message, receiver, createdon, null backedon from sms_out
union all
select row_id, sender, message, receiver, createdon, backedon from sms_out_bak;

prompt
prompt Creating view V_USERS_INSTRUCT
prompt ==============================
prompt
create or replace force view v_users_instruct as
select ins_id,
       t.createdon,
       t.subject,
       t.content,
       t.priority,
        (select c.code_name  from common_code c where c.code_type = 'priority' and c.code_id = t.priority) priority_name,
       t.status,
       (select  c.code_name from common_code c where c.code_type = 'UserInstructStatus' and c.code_id = t.status) status_name,
       t.status_time,
       t.createdbyid,
       t.createdbyacc,
       (select p.partner_name from partner p where p.partner_acc = t.createdbyacc) createdby_name,
       t.expire_time
  from users_instruct t;

prompt
prompt Creating view V_USERS_INSTRUCT_HIS
prompt ==================================
prompt
create or replace force view v_users_instruct_his as
select t.his_id,
       t.ins_id,
       t.partner_id,
       t.partner_acc,
        (select p.partner_name from partner p where p.partner_acc = t.partner_acc) partner_name,
       t.content,
       t.subject,
       t.priority,
        (select c.code_name  from common_code c where c.code_type = 'priority' and c.code_id = t.priority) priority_name,
       t.status,
        (select  c.code_name from common_code c where c.code_type = 'UserInstructHisStatus' and c.code_id = t.status) status_name,
       t.status_time,
       t.createdbyid,
       t.createdbyacc,
         (select p.partner_name from partner p where p.partner_acc = t.createdbyacc) createdby_name,
       t.expire_time,
       t.createdon,
       t.historyon
  from users_instruct_his t;

prompt
prompt Creating package PK_INFRA
prompt =========================
prompt
create or replace package pk_infra is

  -- Author  : MBESHR
  -- Created : 27/11/2020 20:18:22 20:18:22 
  -- Purpose : 
  

function fn_CreatePartner (
v_partner_id                partner.partner_id%type, 
v_partner_name              partner.partner_name%type,
v_brandname                 partner.brandname%type,
v_roleid                    partner.roleid%type, 
v_id_no                     partner.id_no%type, 
v_id_type                   partner.id_type%type, 
v_id_place                  partner.id_place%type,
v_id_issued                 partner.id_issued%type, 
v_createdby                 partner.createdby%type, 
v_cityid                    partner.cityid%type, 
v_districtid                partner.districtid%type, 
v_street                    partner.street%type, 
v_zone                      partner.zone%type, 
v_extra_address             partner.extra_address%type, 
v_pair_mobile               partner.pair_mobile%type, 
v_mobile                    partner.mobile%type, 
v_fixed                     partner.fixed%type, 
v_fax                       partner.fax%type, 
v_email                     partner.email%type, 
v_pwd                       partner.pwd%type, 
v_extra                     partner.extra%type, 
v_ip_address                partner.ip_address%type,
v_ref_partner   partner.ref_partner%type
   
  ) return number ;


function fn_UpdatePartner (
v_partner_name              partner.partner_name%type,
v_brandname                 partner.brandname%type,
v_roleid                    partner.roleid%type, 
v_id_no                     partner.id_no%type, 
v_id_type                   partner.id_type%type, 
v_id_place                  partner.id_place%type,
v_id_issued                 partner.id_issued%type, 
v_createdby                 partner.createdby%type, 
v_cityid                    partner.cityid%type, 
v_districtid                partner.districtid%type, 
v_street                    partner.street%type, 
v_zone                      partner.zone%type, 
v_extra_address             partner.extra_address%type, 
v_pair_mobile               partner.pair_mobile%type, 
v_mobile                    partner.mobile%type, 
v_fixed                     partner.fixed%type, 
v_fax                       partner.fax%type, 
v_email                     partner.email%type, 
v_ip_address                partner.ip_address%type,
v_partner_acc               partner.partner_acc%type,
v_ref_partner   partner.ref_partner%type
   
  ) return number;

function fn_deletePartner(  v_partner_acc partner.partner_acc%type, 
  v_createdby partner.partner_id%type) return number;


function fn_createOutSMS(
v_message   sms_out.message%type, 
v_receiver  sms_out.receiver%type) return number;


function fn_ResetPassword(
  v_partner_acc               partner.partner_acc%type,
  v_pwd                       partner.pwd%type, 
   v_extra                     partner.extra%type,
   v_createdby   partner.partner_id%type
  ) return number;
  
  function fn_ChangePassword(
  v_partner_acc               partner.partner_acc%type,
  v_pwd                       partner.pwd%type, 
   v_extra                     partner.extra%type
  ) return number;
  
   function fn_create_in_sms(
    v_reciever sms_in.reciever%type, 
    v_sender sms_in.sender%type, 
    v_message sms_in.message%type,
    v_ref_no sms_in.ref_no%type,
     v_lang sms_in.lang%type
    ) return number;
    
    function fn_Create_Partner_Request(
   v_req_id partner_request.req_id%type, 
  v_req_content partner_request.req_content%type, 
  v_replay_time partner_request.replay_time%type, 
  v_replay_desc partner_request.replay_desc%type, 
  v_replay_shortcode partner_request.replay_shortcode%type, 
  v_status partner_request.status%type, 
  v_queue_no partner_request.queue_no%type,
  v_error partner_request.error%type,
  v_accesschannel partner_request.accesschannel%type
  ) return number;
  
  
  function fn_Create_PartnerStatus_log(
    v_createdby           PARTNER_STATUS_LOG.createdby%type,         
  v_createdbyacc        PARTNER_STATUS_LOG.createdbyacc%type,      
  v_partner_id          PARTNER_STATUS_LOG.partner_id%type,        
  v_partner_acc         PARTNER_STATUS_LOG.partner_acc%type,       
  v_old_status          PARTNER_STATUS_LOG.old_status%type,        
  v_new_status          PARTNER_STATUS_LOG.new_status%type,        
  v_note                PARTNER_STATUS_LOG.note%type,              
  v_newstatus_expireon  PARTNER_STATUS_LOG.newstatus_expireon%type
  ) return number;  
  
  
  function fn_Create_SMSOne (
  v_createdby    SEND_SMSONE_HIS.createdby%type,
  v_createdbyacc SEND_SMSONE_HIS.createdbyacc%type,
  v_receiver     SEND_SMSONE_HIS.receiver%type,
  v_msg          SEND_SMSONE_HIS.msg%type,
  v_note         SEND_SMSONE_HIS.note%type
  ) return number;
  
  procedure sp_Create_PFR (
    v_act_time    PFINREC.act_time%type,
    v_partner_acc  PFINREC.partner_acc%type,
    v_amount       PFINREC.amount%type,
    v_act_id       PFINREC.act_id%type,
    v_act_no       PFINREC.act_no%type,
    v_createdbyacc PFINREC.createdbyacc%type
    );
   function fn_Create_Notification(
     v_partner_id  notification.partner_id%type ,
      v_notify_msg  notification.notify_msg%type ,
      v_act_id      notification.act_id%type     ,
      v_ref_no      notification.ref_no%type   
   ) return number;
   
   function fn_Create_bgService(
     v_createdby     bg_service.createdby%type    ,
     v_createdbyacc  bg_service.createdbyacc%type ,
     v_bg_source     bg_service.bg_source%type    ,
     v_partner_id    bg_service.partner_id%type   ,
      v_partner_acc   bg_service.partner_acc%type,
     v_start_date    bg_service.start_date%type   ,
     v_end_date      bg_service.end_date%type  ,
      v_note      bg_service.note%type ,
      v_active_time     bg_service.active_time%type ,
      v_service_name    bg_service.service_name%type
     ) return number;
     
     function fn_Update_bgService(
     v_bg_id         bg_service.bg_id%type     ,
      v_record_count  bg_service.record_count%type ,
      v_file_name     bg_service.file_name%type    ,
      v_file_location bg_service.file_location%type,
      v_status        bg_service.status%type       ,
      v_status_time   bg_service.status_time%type  ,
      v_duration_sec  bg_service.duration_sec%type    ,
       v_file_size    bg_service.file_size%type
     ) return number;
     
 function fn_UpdateBgServActualStartTime (
   v_bg_id         bg_service.bg_id%type,
   v_actual_start_time         bg_service.actual_start_time%type
   ) return number;
   
   function fn_bgService_processing_start (
     v_bg_id         bg_service.bg_id%type,
     v_setActualTime  number
 ) return number;
 
 function fn_Create_UsersInstruct(
  v_subject       users_instruct.subject%type,
  v_content       users_instruct.content%type,
  v_priority      users_instruct.priority%type,
  v_createdbyid   users_instruct.createdbyid%type,
  v_expire_time   users_instruct.expire_time%type ,
   v_post_it number
 ) return number;
 
 function fn_Create_UserInstructTo(
  v_ins_id  users_instruct_to.ins_id%type, 
  v_role_id users_instruct_to.role_id%type
   ) return number;
   
 function fn_Create_UsersInstruct_his(
  v_ins_id        users_instruct_his.ins_id%type,
   v_subject       users_instruct_his.subject%type,
  v_content       users_instruct_his.content%type,
  v_partner_id  users_instruct_his.partner_id%type,
  v_createdon     users_instruct_his.createdon%type,
  v_priority      users_instruct_his.priority%type,
  v_createdbyid   users_instruct_his.createdbyid%type,
  v_createdbyacc  users_instruct_his.createdbyacc%type,
  v_expire_time   users_instruct_his.expire_time%type 
 ) return number;
 
function fn_read_UserInstructHis(
   v_his_id        users_instruct_his.his_id%type
) return number;

function fn_UserInstruct_post(
   v_ins_id        users_instruct.ins_id%type
) return number;

function fn_UserInstruct_Delete(
   v_ins_id        users_instruct.ins_id%type
) return number;

function fn_UserInstructTo_Delete(
 v_to_id   users_instruct_to.to_id%type
) return number;

function fn_create_api_ip_blacklist(
  v_ip_address api_ip_blacklist.ip_address%type
  ) return number;

function fn_create_api_log(
  v_log_data api_log.log_data%type,
  v_log_user api_log.log_user%type,
  v_log_ip api_log.log_ip%type,
  v_log_level  api_log.log_level%type,
    v_log_action  api_log.log_action%type
  ) return number;

end pk_infra;
/

prompt
prompt Creating package PK_SETTINGS
prompt ============================
prompt
create or replace package pk_Settings is

  -- Author  : MBESHR
  -- Created : 23/11/2020 20:18:31 20:18:31 
  -- Purpose : 
  
 function fn_CreatePartnerActivity (

  v_act_id partner_activity.act_id%type, 
  v_fromroleid partner_activity.fromroleid%type, 
  v_queryduration partner_activity.queryduration%type, 
  v_act_scope partner_activity.act_scope%type, 
  v_maxrec partner_activity.maxrec%type, 
  v_onlypartchildren partner_activity.onlypartchildren%type, 
  v_createdby partner_activity.createdby%type,
  v_createdbyacc partner_activity.createdbyacc%type
  
  ) return number;

   function fn_UpdatePartnerActivity (
    v_row_id partner_activity.row_id%type,
    v_act_id partner_activity.act_id%type, 
    v_fromroleid partner_activity.fromroleid%type, 
    v_queryduration partner_activity.queryduration%type, 
    v_act_scope partner_activity.act_scope%type, 
    v_maxrec partner_activity.maxrec%type, 
    v_onlypartchildren partner_activity.onlypartchildren%type
  ) return number;

function fn_CreatePartnerActivityDetail (
  v_master_row partner_activity_detail.master_row%type, 
  v_dest_role_id partner_activity_detail.dest_role_id%type, 
  v_check_bal partner_activity_detail.check_bal%type, 
  v_max_value partner_activity_detail.max_value%type, 
  v_min_value partner_activity_detail.min_value%type, 
  v_bonus_per partner_activity_detail.bonus_per%type, 
  v_taxper partner_activity_detail.taxper%type, 
  v_bonus_tax partner_activity_detail.bonus_tax%type,
  v_createdby partner_activity_detail.createdby%type,
  v_createdbyacc partner_activity_detail.createdbyacc%type
  ) return number;
  
  function fn_UpdatePartnerActivityDetail (
  v_row_id partner_activity_detail.row_id%type, 
  v_master_row partner_activity_detail.master_row%type, 
  v_dest_role_id partner_activity_detail.dest_role_id%type, 
  v_check_bal partner_activity_detail.check_bal%type, 
  v_max_value partner_activity_detail.max_value%type, 
  v_min_value partner_activity_detail.min_value%type, 
  v_bonus_per partner_activity_detail.bonus_per%type, 
  v_taxper partner_activity_detail.taxper%type, 
  v_bonus_tax partner_activity_detail.bonus_tax%type,
  v_createdby partner_activity.createdby%type
  ) return number;
  
  function fn_Create_Message_Template(
    v_msg_name message_template.msg_name%type, 
    v_msg_text message_template.msg_text%type, 
    v_createdby message_template.createdby%type, 
    v_createdbyacc message_template.createdbyacc%type,
     v_towho message_template.towho%type
    ) return number;
  
  
    function fn_Update_Message_Template(
    v_msg_id message_template.msg_id%type,
    v_msg_name message_template.msg_name%type, 
    v_msg_text message_template.msg_text%type,
     v_towho message_template.towho%type
    ) return number;
    
    function fn_Create_Activity_Message(
      v_act_id Activity_Message.act_id%type, 
      v_msg_id Activity_Message.msg_id%type, 
      v_sending_time Activity_Message.Sending_Time%type, 
      v_createdby Activity_Message.createdby%type, 
      v_createdbyacc Activity_Message.createdbyacc%type,
      v_msg_order Activity_Message.Msg_Order%type
      ) return number;
      
       function fn_Delete_Activity_Message(
      v_act_id Activity_Message.act_id%type, 
      v_msg_id Activity_Message.msg_id%type)
      return number;
      
       function fn_Reorder_Activity_Message(
      v_act_id Activity_Message.act_id%type)return number;
end pk_Settings;
/

prompt
prompt Creating package PK_UTILITY
prompt ===========================
prompt
create or replace package pk_Utility is

  -- Author  : MBESHR
  -- Created : 28/11/2020 17:16:31 17:16:31 
  -- Purpose : 
  
procedure sp_Create_Audit(
v_partner_id    data_audit.partner_id%type,
v_partner_acc    data_audit.partner_acc%type,
v_act_id        data_audit.act_id%type,
v_action_id     data_audit.action_id%type,
v_note          data_audit.note%type,
v_old_value     data_audit.old_value%type,
v_new_value     data_audit.new_value%type,
v_system_note   data_audit.system_note%type,
v_error         data_audit.error%type,
v_success       data_audit.success%type
) ;

function fn_GetActiveAccount(v_partner_id partner.partner_id%type) return number;

function fn_IsPartnerActivityDefined(
  v_act_id activities.act_id%type,
  v_fromRoleId approle.roleid%type,
  v_toRoleId approle.roleid%type) return number;
  
function fn_GetPartnerBalance(v_partner_acc partner.partner_acc%type) return partner.balance%type;  

function fn_IsIdlePartner(v_partner_acc partner.partner_acc%type) return number;

function fn_GetPartnerRole(v_partner_acc partner.partner_acc%type) return partner.roleid%type ;
  
function fn_GetPartnerStatus(v_partner_acc partner.partner_acc%type) return partner.status%type;

procedure sp_tmp_log(
  v_log tmp_log.log%type,
  v_act  tmp_log.act%type
  );
end pk_Utility;
/

prompt
prompt Creating function FN_GEN_INSERTS
prompt ================================
prompt
CREATE OR REPLACE FUNCTION fn_gen_inserts
(
  p_sql                        CLOB,
  p_new_owner_name             VARCHAR2,
  p_new_table_name             VARCHAR2
)
RETURN CLOB
IS
  l_cur                        NUMBER;
  l_sql                        CLOB := p_sql;
  l_ret                        NUMBER;
  l_col_cnt                    NUMBER;
  l_rec_tab                    dbms_sql.desc_tab;

  l_separator                  CHAR(1) := '!';
  l_clob                       CLOB;
  l_clob_line                  CLOB;
  l_clob_ins                   CLOB;
  l_clob_all                   CLOB;
  l_line                       CLOB := '-----------------------------------';

  cons_date_frm                VARCHAR2(32) := 'DD.MM.YYYY HH24:MI:SS';
  cons_timestamp_frm           VARCHAR2(32) := 'DD.MM.YYYY HH24:MI:SSXFF';
  cons_timestamp_wtz_frm       VARCHAR2(32) := 'DD.MM.YYYY HH24:MI:SSXFF TZR';

  cons_varchar2_code           NUMBER := 1;
  cons_nvarchar2_code          NUMBER := 1;
  cons_number_code             NUMBER := 2;
  cons_float_code              NUMBER := 2;
  cons_long_code               NUMBER := 8;
  cons_date_code               NUMBER := 12;
  cons_binary_float_code       NUMBER := 100;
  cons_binary_double_code      NUMBER := 101;
  cons_timestamp_code          NUMBER := 180;
  cons_timestamp_wtz_code      NUMBER := 181;
  cons_timestamp_lwtz_code     NUMBER := 231;
  cons_interval_ytm_code       NUMBER := 182;
  cons_interval_dts_code       NUMBER := 183;
  cons_raw_code                NUMBER := 23;
  cons_long_raw_code           NUMBER := 24;
  cons_rowid_code              NUMBER := 11;
  cons_urowid_code             NUMBER := 208;
  cons_char_code               NUMBER := 96;
  cons_nchar_code              NUMBER := 96;
  cons_clob_code               NUMBER := 112;
  cons_nclob_code              NUMBER := 112;
  cons_blob_code               NUMBER := 113;
  cons_bfile_code              NUMBER := 114;
  cons_xmltype_code            NUMBER := 109;

  -------------------------------------
  -- Supported types
  -------------------------------------
  l_varchar2_col                VARCHAR2(32767); --1
  l_number_col                  NUMBER;          --2
  --l_long_col                    long;          --8 - not supported
  l_date_col                    DATE;            --12
  --l_raw_col                     raw(2000);     --23 - not supported
  l_rowid_col                   ROWID;           --69
  l_char_col                    CHAR(2000);      --96
  l_binary_float_col            BINARY_FLOAT;    --100
  l_binary_double_col           BINARY_DOUBLE;   --101
  l_clob_col                    CLOB;            --112
  l_timestamp_col               TIMESTAMP(9);    --180
  l_timestamp_wtz_col           TIMESTAMP(9) WITH TIME ZONE;    --181
  l_interval_ytm_col            INTERVAL YEAR(9) TO MONTH;      --182
  l_interval_dts_col            INTERVAL DAY(9) TO SECOND(2);   --183
  l_urowid_col                  UROWID;                         --208
  l_timestamp_wltz_col          TIMESTAMP WITH LOCAL TIME ZONE; --231
  l_xmltype_col                 XMLTYPE; --109
  --l_nchar_col                   nchar(2000); --96 the same as char
  --l_nclob_col                   nclob; --112 the same as clob
  --l_blob_col - not supported
  --l_bfile_col - not supported
  --l_long_raw_col - not supported

  PROCEDURE print_rec(rec IN dbms_sql.desc_rec) IS
  BEGIN
    l_clob_all := l_clob_all||chr(10)||
      'col_type            =    ' || rec.col_type||chr(10)||
      'col_maxlen          =    ' || rec.col_max_len||chr(10)||
      'col_name            =    ' || rec.col_name||chr(10)||
      'col_name_len        =    ' || rec.col_name_len||chr(10)||
      'col_schema_name     =    ' || rec.col_schema_name||chr(10)||
      'col_schema_name_len =    ' || rec.col_schema_name_len||chr(10)||
      'col_precision       =    ' || rec.col_precision||chr(10)||
      'col_scale           =    ' || rec.col_scale||chr(10)||
      'col_null_ok         =    ';

    IF (rec.col_null_ok) THEN
      l_clob_all := l_clob_all||'true'||chr(10);
    ELSE
      l_clob_all := l_clob_all||'false'||chr(10);
    END IF;
  END;
BEGIN
  ---------------------------------------
  -- INSERT - header generation
  ---------------------------------------
  l_clob_all :=
  'declare'||chr(10)||
  '  type   t_clob is table of clob index by binary_integer;'||chr(10)||
  '  l_clob t_clob;'||chr(10)||
  '  type   t_varchar2 is table of varchar2(64) index by binary_integer;'||chr(10)||
  '  l_varchar2 t_varchar2;'||chr(10)||
  'begin'||chr(10)||
  '/*'||chr(10);

  ---------------------------------------
  -- Introduction
  ---------------------------------------
  l_clob_all := l_clob_all||l_line||chr(10)||'Parsing query:'||chr(10)||l_sql||chr(10);

  ---------------------------------------
  -- Open parse cursor
  ---------------------------------------
  l_cur := dbms_sql.open_cursor;
  dbms_sql.parse(l_cur, l_sql, dbms_sql.NATIVE);

  ---------------------------------------
  -- Describe columns
  ---------------------------------------
  l_clob_all := l_clob_all||l_line||chr(10)||'Describe columns:'||chr(10);

  dbms_sql.describe_columns(l_cur, l_col_cnt, l_rec_tab);

  FOR i IN 1..l_rec_tab.count
  loop
    print_rec(l_rec_tab(i));
  END loop;

  l_clob_all := l_clob_all||chr(10)||
            '*/'||chr(10)||
            '  '||chr(10)||l_line||chr(10)||
            '  -- start generation of records'||chr(10)||
            '  '||l_line||chr(10);

  ---------------------------------------
  -- Define columns
  ---------------------------------------
  FOR i IN 1..l_rec_tab.count
  loop
    IF    l_rec_tab(i).col_type = cons_varchar2_code THEN --varchar2
      dbms_sql.define_column(l_cur, i, l_varchar2_col, l_rec_tab(i).col_max_len);
    elsif l_rec_tab(i).col_type = cons_number_code THEN --number
      dbms_sql.define_column(l_cur, i, l_number_col);
    --elsif l_rec_tab(i).col_type = cons_long_code then --long
    --  dbms_sql.define_column_long(l_cur, i);
    elsif l_rec_tab(i).col_type = cons_date_code THEN --date
      dbms_sql.define_column(l_cur, i, l_date_col);
    elsif l_rec_tab(i).col_type = cons_binary_float_code THEN --binary_float
      dbms_sql.define_column(l_cur, i, l_binary_float_col);
    elsif l_rec_tab(i).col_type = cons_binary_double_code THEN --binary_double
      dbms_sql.define_column(l_cur, i, l_binary_double_col);
--    elsif l_rec_tab(i).col_type = cons_raw_code then --raw
--      dbms_sql.define_column_raw(l_cur, i, l_raw_col, l_rec_tab(i).col_max_len);
    elsif l_rec_tab(i).col_type = cons_rowid_code THEN  --rowid
      dbms_sql.define_column_rowid(l_cur, i, l_rowid_col);
    elsif l_rec_tab(i).col_type = cons_char_code THEN  --char
      dbms_sql.define_column_char(l_cur, i, l_char_col, l_rec_tab(i).col_max_len);
    elsif l_rec_tab(i).col_type = cons_clob_code THEN --clob
      dbms_sql.define_column(l_cur, i, l_clob_col);
    elsif l_rec_tab(i).col_type = cons_timestamp_code THEN --timestamp
      dbms_sql.define_column(l_cur, i, l_timestamp_col);
    elsif l_rec_tab(i).col_type = cons_timestamp_wtz_code THEN --timestamp with time zone
      dbms_sql.define_column(l_cur, i, l_timestamp_wtz_col);
    elsif l_rec_tab(i).col_type = cons_rowid_code THEN --urowid
      dbms_sql.define_column(l_cur, i, l_urowid_col);
    elsif l_rec_tab(i).col_type = cons_timestamp_lwtz_code THEN --timestamp with local time zone
      dbms_sql.define_column(l_cur, i, l_timestamp_wltz_col);
    elsif l_rec_tab(i).col_type = cons_interval_ytm_code THEN --interval year to month
      dbms_sql.define_column(l_cur, i, l_interval_ytm_col);
    elsif l_rec_tab(i).col_type = cons_interval_dts_code THEN --interval day to second
      dbms_sql.define_column(l_cur, i, l_interval_dts_col);
    elsif l_rec_tab(i).col_type = cons_urowid_code THEN --urowid
      dbms_sql.define_column(l_cur, i, l_urowid_col);
    elsif l_rec_tab(i).col_type = cons_xmltype_code THEN --xmltype
      dbms_sql.define_column(l_cur, i, l_xmltype_col);
    ELSE
      raise_application_error(-20001, 'Column: '||l_rec_tab(i).col_name||chr(10)||
                                      'Type not supported: '||l_rec_tab(i).col_type);
      --not supported
    END IF;
  END loop;

  ---------------------------------------
  -- Execute cursor
  ---------------------------------------
  l_ret := dbms_sql.EXECUTE(l_cur);

  ---------------------------------------
  -- Fetch rows
  ---------------------------------------
  loop
    l_ret := dbms_sql.fetch_rows(l_cur);
    exit WHEN l_ret = 0;

    ---------------------------------------
    -- Building INSERT - build column declarations
    ---------------------------------------
    l_clob_line := '';

    FOR i IN 1..l_rec_tab.count
    loop
      IF    l_rec_tab(i).col_type = cons_varchar2_code THEN --varchar2
        dbms_sql.COLUMN_VALUE(l_cur, i, l_varchar2_col);
        l_clob := l_varchar2_col;
      elsif l_rec_tab(i).col_type = cons_number_code THEN --number
        dbms_sql.COLUMN_VALUE(l_cur, i, l_number_col);
        l_clob := to_char(l_number_col);
--      elsif l_rec_tab(i).col_type = cons_long_code then --long
--        dbms_sql.column_value(l_cur, i, l_long_col);
--        l_clob := l_long_col;
      elsif l_rec_tab(i).col_type = cons_date_code THEN --date
        dbms_sql.COLUMN_VALUE(l_cur, i, l_date_col);
        l_clob := to_char(l_date_col, cons_date_frm);
      elsif l_rec_tab(i).col_type = cons_binary_float_code THEN --binary_float
        dbms_sql.COLUMN_VALUE(l_cur, i, l_binary_float_col);
        l_clob := to_char(l_binary_float_col);
      elsif l_rec_tab(i).col_type = cons_binary_double_code THEN --binary_double
        dbms_sql.COLUMN_VALUE(l_cur, i, l_binary_double_col);
        l_clob := to_char(l_binary_double_col);
--      elsif l_rec_tab(i).col_type = cons_raw_code then --raw
--        dbms_sql.column_value(l_cur, i, l_raw_col);
--        l_clob := to_char(l_raw_col);
      elsif l_rec_tab(i).col_type = cons_rowid_code THEN --rowid
        dbms_sql.COLUMN_VALUE(l_cur, i, l_rowid_col);
        l_clob := to_char(l_rowid_col);
      elsif l_rec_tab(i).col_type = cons_char_code THEN --char
        dbms_sql.column_value_char(l_cur, i, l_char_col);
        l_clob := substr(l_char_col, 1, l_rec_tab(i).col_max_len - 1);
      elsif l_rec_tab(i).col_type = cons_clob_code THEN --clob
        dbms_sql.COLUMN_VALUE(l_cur, i, l_clob_col);
        l_clob := l_clob_col;
      elsif l_rec_tab(i).col_type = cons_timestamp_code THEN --timestamp
        dbms_sql.COLUMN_VALUE(l_cur, i, l_timestamp_col);
        l_clob := to_char(l_timestamp_col, cons_timestamp_frm);
      elsif l_rec_tab(i).col_type = cons_timestamp_wtz_code THEN --timestamp with time zone
        dbms_sql.COLUMN_VALUE(l_cur, i, l_timestamp_wtz_col);
        l_clob := to_char(l_timestamp_wtz_col, cons_timestamp_wtz_frm);
      elsif l_rec_tab(i).col_type = cons_interval_ytm_code THEN --interval year to month
        dbms_sql.COLUMN_VALUE(l_cur, i, l_interval_ytm_col);
        l_clob := to_char(l_interval_ytm_col);
      elsif l_rec_tab(i).col_type = cons_interval_dts_code THEN --interval day to second
        dbms_sql.COLUMN_VALUE(l_cur, i, l_interval_dts_col);
        l_clob := to_char(l_interval_dts_col);
      elsif l_rec_tab(i).col_type = cons_urowid_code THEN --urowid
        dbms_sql.COLUMN_VALUE(l_cur, i, l_urowid_col);
        l_clob := to_char(l_urowid_col);
      elsif l_rec_tab(i).col_type = cons_timestamp_lwtz_code THEN --timestamp with local time zone
        dbms_sql.COLUMN_VALUE(l_cur, i, l_timestamp_wltz_col);
        l_clob := to_char(l_timestamp_wltz_col, cons_timestamp_wtz_frm);
      elsif l_rec_tab(i).col_type = cons_xmltype_code THEN --xmltype
        dbms_sql.COLUMN_VALUE(l_cur, i, l_xmltype_col);
        l_clob := l_xmltype_col.getclobval();
      END IF;

      IF l_rec_tab(i).col_type IN (cons_clob_code, cons_char_code, cons_varchar2_code) THEN
        l_clob_line := l_clob_line||'  l_clob('||to_char(i)||') :=q'''||l_separator||l_clob||l_separator||''';'||chr(10);
      ELSIF l_rec_tab(i).col_type IN (cons_xmltype_code) THEN
        l_clob_line := l_clob_line||'  l_clob('||to_char(i)||') :=q'''||l_separator||l_clob||l_separator||''';'||chr(10);
      ELSE
        l_clob_line := l_clob_line||'  l_varchar2('||to_char(i)||') :=q'''||l_separator||l_clob||l_separator||''';'||chr(10);
      END IF;
    END loop;

    l_clob_all := l_clob_all||chr(10)||l_clob_line;

    ---------------------------------------
    -- Building INSERT - build column list
    ---------------------------------------
    l_clob_all := l_clob_all||chr(10)||
              '  insert into '||p_new_owner_name||'.'||p_new_table_name||chr(10)||
              '  ('||chr(10);

    FOR i IN 1..l_rec_tab.count
    loop
      IF i = 1 THEN
        l_clob_all := l_clob_all||'     '||l_rec_tab(i).col_name||chr(10);
      ELSE
        l_clob_all := l_clob_all||'    ,'||l_rec_tab(i).col_name||chr(10);
      END IF;
    END loop;

    l_clob_all := l_clob_all||
              '  )'||chr(10)||
              '  values'||chr(10)||
              '  ('||chr(10);

    ---------------------------------------
    -- Building INSERT - build values
    ---------------------------------------
    FOR i IN 1..l_rec_tab.count
    loop
      IF i!=1 THEN
        l_clob_all := l_clob_all||'    ,';
      ELSE
        l_clob_all := l_clob_all||'     ';
      END IF;

      IF l_rec_tab(i).col_type = cons_number_code THEN --number
        l_clob_all := l_clob_all||'to_number(l_varchar2('||to_char(i)||'))'||chr(10);
--      elsif l_rec_tab(i).col_type = cons_long_code then --long
--        l_clob := l_long_col;
      elsif l_rec_tab(i).col_type = cons_clob_code THEN --clob, xmltype
        l_clob_all := l_clob_all||'l_clob('||to_char(i)||')'||chr(10);
      ELSIF L_REC_TAB(I).COL_TYPE = CONS_XMLTYPE_CODE then --clob, xmltype
        l_clob_all := l_clob_all||'xmltype(l_clob('||to_char(i)||'))'||chr(10);
      elsif l_rec_tab(i).col_type = cons_char_code THEN --timestamp with local time zone
        l_clob_all := l_clob_all||'to_char(l_clob('||to_char(i)||'))'||chr(10);
      elsif l_rec_tab(i).col_type = cons_varchar2_code THEN --timestamp with local time zone
        l_clob_all := l_clob_all||'to_char(l_clob('||to_char(i)||'))'||chr(10);
      elsif l_rec_tab(i).col_type = cons_date_code THEN --date
        l_clob_all := l_clob_all||'to_date(l_varchar2('||to_char(i)||'),'''||cons_date_frm||''')'||chr(10);
      elsif l_rec_tab(i).col_type = cons_timestamp_code THEN --timestamp
        l_clob_all := l_clob_all||'to_timestamp(l_varchar2('||to_char(i)||'),'''||cons_timestamp_frm||''')'||chr(10);
      elsif l_rec_tab(i).col_type = cons_timestamp_wtz_code THEN --timestamp with time zone
        l_clob_all := l_clob_all||'to_timestamp_tz(l_varchar2('||to_char(i)||'),'''||cons_timestamp_wtz_frm||''')'||chr(10);
      elsif l_rec_tab(i).col_type = cons_interval_ytm_code THEN --interval year to month
        l_clob_all := l_clob_all||'to_yminterval(l_varchar2('||to_char(i)||'))'||chr(10);
      elsif l_rec_tab(i).col_type = cons_interval_dts_code THEN --interval day to second
        l_clob_all := l_clob_all||'to_dsinterval(l_varchar2('||to_char(i)||'))'||chr(10);
      elsif l_rec_tab(i).col_type = cons_timestamp_lwtz_code THEN --timestamp with local time zone
        l_clob_all := l_clob_all||'to_timestamp_tz(l_varchar2('||to_char(i)||'),'''||cons_timestamp_wtz_frm||''')'||chr(10);
      ELSE
        l_clob_all := l_clob_all||'l_varchar2('||to_char(i)||')'||chr(10);
      END IF;
    END loop;

    l_clob_all := l_clob_all||'  );'||chr(10);
  END loop;

  ---------------------------------------
  -- Building INSERT - end of code
  ---------------------------------------
  l_clob_all := l_clob_all||chr(10)||'end;';
  l_clob_all := l_clob_all||chr(10)||'/';

  ---------------------------------------
  -- Close cursor
  ---------------------------------------
  dbms_sql.close_cursor(l_cur);

  RETURN l_clob_all;
END;
/

prompt
prompt Creating procedure SP_ADD_EXCEPTION
prompt ===================================
prompt
create or replace procedure sp_add_exception(
 v_exp_code operation_exception.exp_code%type,
 v_exp_message operation_exception.exp_message%type, 
 v_exp_operation operation_exception.exp_operation%type,
 v_exp_object operation_exception.exp_object%type
) is
begin
  insert into operation_exception
  (exp_code, exp_message, exp_date, exp_operation, exp_object)
 values
  (v_exp_code, v_exp_message, sysdate, v_exp_operation, v_exp_object);
end sp_add_exception;
/

prompt
prompt Creating package body PK_FINANCIAL
prompt ==================================
prompt
create or replace package body pk_financial is

function fn_MoneyTransfer (
  v_part_id money_transfer.part_id%type,
  v_pay_type money_transfer.pay_type%type,
  v_pay_no money_transfer.pay_no%type,
  v_pay_date money_transfer.pay_date%type,
  v_bank_name money_transfer.bank_name%type,
  v_createdby money_transfer.createdby%type,
  v_access_channel money_transfer.access_channel%type,
  v_amount money_transfer.amount%type,
  v_bill_no money_transfer.bill_no%type,
  v_request_no money_transfer.request_no%type,
  v_request_amt money_transfer.request_amt%type,
  v_note money_transfer.note%type,
  v_api_trans money_transfer.api_trans%type
  
  ) return number is
  
    v_trans_id money_transfer.trans_id%TYPE;
    v_part_bal money_transfer.part_bal%TYPE;
    v_part_role_id money_transfer.part_role_id%TYPE;
    v_creator_bal money_transfer.creator_bal%TYPE;
    v_creator_role_id money_transfer.creator_role_id%TYPE;
    v_net_amount money_transfer.net_amount%TYPE;
    v_tax_per money_transfer.tax_per%TYPE;
    v_tax_amt money_transfer.tax_amt%TYPE;
    v_bonus_per money_transfer.bonus_per%TYPE;
    v_bonus_amt money_transfer.bonus_amt%TYPE;
    v_bonus_tax money_transfer.bonus_tax%TYPE;
    v_bonus_tax_amt money_transfer.bonus_tax_amt%TYPE;
    v_received_amt money_transfer.received_amt%TYPE;
    v_Min_Value partner_activity_detail.min_value%TYPE;
    v_Max_Value partner_activity_detail.max_value%TYPE;
    v_check_bal partner_activity_detail.check_bal%TYPE;
    v_part_acc partner.partner_acc%TYPE;
    v_creator_acc partner.partner_acc%TYPE;
    v_partnerActivityFound number := 0;
    v_result number;
   v_tmp number;

  
  BEGIN
     --SET AUTOCOMMIT OFF;
      
     
     v_part_acc := pk_utility.fn_getactiveaccount(v_partner_id => v_part_id);
     if (v_part_acc = -1) then
       begin
           --message := 'no active account found';
          return -506;
       end;
      end if; 
      v_creator_acc := pk_utility.fn_getactiveaccount(v_partner_id => v_createdby);
     if (v_creator_acc = -1) then
       begin
           --message := 'no active account found';
          return -506;
       end;
      end if; 
     
      v_part_bal := pk_utility.fn_getpartnerbalance(v_partner_acc => v_part_acc);
      if (v_part_bal = -1) then
       begin
           --message := 'inconsistent data';
          return -507;
       end;
      end if; 
      
      v_creator_bal := pk_utility.fn_getpartnerbalance(v_partner_acc => v_creator_acc);
      if (v_creator_bal = -1) then
       begin
           --message := 'inconsistent data';
          return -507;
       end;
      end if; 
          
     select partner.roleid into v_part_role_id from partner where partner_acc = v_part_acc;
     select partner.roleid into v_creator_role_id from partner where partner_acc =v_creator_acc;
     
     v_partnerActivityFound := pk_utility.fn_ispartneractivitydefined(v_act_id => 'MoneyTransfer.Create',
                                                    v_fromroleid => v_creator_role_id,
                                                    v_toroleid => v_part_role_id);
                                                    
      if (v_partnerActivityFound <> 1) then
       begin
           --message := 'no setting defined';
          return -500;
       end;
      end if;
     
     if (v_access_channel = 'api') then
       begin
           select  nvl(count(*),0) into v_tmp from money_transfer where  creator_acc = v_creator_acc and api_trans = v_api_trans and access_channel = 'api';
           if (v_tmp > 0) then
             begin
                return -508;
             end;
           end if;
       end;
     end if;
         
     
     
     
     select nvl(taxper,0) into v_tax_per from v_partner_activity_detail where act_id = 'MoneyTransfer.Create' and fromroleid = v_creator_role_id and toroleid = v_part_role_id;
     select nvl(bonus_per,0) into v_bonus_per from v_partner_activity_detail where act_id = 'MoneyTransfer.Create' and fromroleid = v_creator_role_id and toroleid = v_part_role_id;
     select nvl(bonus_tax,0) into v_bonus_tax from v_partner_activity_detail where act_id = 'MoneyTransfer.Create' and fromroleid = v_creator_role_id and toroleid = v_part_role_id;
     select nvl(Min_Value,0) into v_Min_Value from v_partner_activity_detail where act_id = 'MoneyTransfer.Create' and fromroleid = v_creator_role_id and toroleid = v_part_role_id;
     select nvl(Max_Value,0) into v_Max_Value from v_partner_activity_detail where act_id = 'MoneyTransfer.Create' and fromroleid = v_creator_role_id and toroleid = v_part_role_id;
     select nvl(check_bal,0) into v_check_bal from v_partner_activity_detail where act_id = 'MoneyTransfer.Create' and fromroleid = v_creator_role_id and toroleid = v_part_role_id;
     
       
       
      -- check creator balance
     if (v_check_bal = 1 and v_amount > v_creator_bal) then
       begin
           --message := 'balance not enough';
          return -501;
        end ;
     end if;   
      
       if (v_Min_Value > v_amount) then
       begin
           --message := 'Amount less than minimum';
           return -502;
       end;
        end if;  
      
      if (v_Max_Value < v_amount) then
       begin
           --message := 'Amount more than maximum';
           return -503;
       end;
        end if;  
       
        v_net_amount := v_amount / ((v_tax_per / 100) +1);
        v_tax_amt :=  v_net_amount * (v_tax_per / 100);
        v_bonus_amt := v_net_amount * (v_bonus_per / 100);
        v_bonus_tax_amt := v_bonus_amt * (v_bonus_tax / 100);
        v_received_amt := (v_amount -  v_bonus_amt + v_bonus_tax_amt);
    
    v_trans_id := seq_money_transfer_id.nextval();
    insert into money_transfer
      (trans_id, part_id, part_role_id, part_bal, pay_type, pay_no, pay_date, bank_name, createdby, createdon
      , access_channel, amount, tax_per, tax_amt, bonus_per, bonus_amt, bonus_tax, bonus_tax_amt, received_amt
      , net_amount, bill_no, request_no, request_amt, note, adjusted, adjust_id, creator_bal, creator_role_id, part_acc, creator_acc, api_trans)
    values
      (v_trans_id, v_part_id, v_part_role_id, v_part_bal, v_pay_type, v_pay_no, v_pay_date, v_bank_name, v_createdby
      , sysdate, v_access_channel, v_amount, v_tax_per, v_tax_amt, v_bonus_per, v_bonus_amt, v_bonus_tax, v_bonus_tax_amt
      , v_received_amt, v_net_amount, v_bill_no, v_request_no, v_request_amt, v_note, 0, null, v_creator_bal, v_creator_role_id,
       v_part_acc, v_creator_acc, v_api_trans);
    
     update partner set balance = balance + v_amount where partner_acc = v_part_acc;
       pk_infra.sp_create_pfr(v_act_time => sysdate,
                         v_partner_acc => v_part_acc,
                         v_amount => v_amount,
                         v_act_id => 'MoneyTransfer.Create',
                         v_act_no => v_trans_id,
                         v_createdbyacc => v_creator_acc);
     -- build SMS -------------------------------------------------------------
    /*  v_result := pk_infra.fn_createoutsms(v_message => 
      N'   ' 
      || v_amount 
      || N'      ' 
      || v_createdby 
      || N'  ' 
      || v_received_amt 
      || N'  ' 
      || (v_part_bal + v_received_amt),
       v_receiver => v_part_id);*/
     -----------------------------------------------------------------------------
     if (v_check_bal = 1) then
       begin
         update partner set balance = balance - v_amount where partner_acc = v_creator_acc;
         pk_infra.sp_create_pfr(v_act_time => sysdate,
                         v_partner_acc => v_creator_acc,
                         v_amount => -1 * v_amount,
                         v_act_id => 'MoneyTransfer.Create',
                         v_act_no => v_trans_id,
                         v_createdbyacc => v_part_acc);
         -- build SMS -------------------------------------------------------------
        /* v_result := pk_infra.fn_createoutsms(v_message => 
         N'        ' 
         || v_amount 
         || N' .  ' 
         || v_part_id 
         || N'  ' 
         || (v_creator_bal - v_amount)  
          ,  v_receiver => v_createdby);*/
         -----------------------------------------------------------------------------
       end;
    else 
       begin
          -- build SMS -------------------------------------------------------------
         v_result := pk_infra.fn_createoutsms(v_message => 
         N'    ' 
         || v_part_id 
         || N'  ' 
         || v_amount 
         || N'  ' 
         || v_received_amt
         ,  v_receiver => v_createdby);
         -----------------------------------------------------------------------------
       end;
     
     end if;
     commit;
     --message := 'success';
     return v_trans_id;
  
  EXCEPTION

      WHEN OTHERS THEN
         Rollback;
         sp_add_exception(v_exp_code => SQLCODE,
                 v_exp_message => SUBSTR(SQLERRM, 1 , 500),
                 v_exp_operation => 'Create',
                 v_exp_object => 'Money-Transfer');

         return SQLCODE;
  END;

function fn_Create_Adjustment (
v_createdby      adjustment.createdby%type, 
v_moneytranferid adjustment.moneytranferid%type, 
v_amount         adjustment.amount%type, 
v_access_channel adjustment.access_channel%type, 
v_note           adjustment.note%type,
v_createdbyacc      adjustment.createdbyacc%type
) return number is
v_adj_id          adjustment.adj_id%type;
v_src_bal        adjustment.src_bal%type; 
v_dest_bal       adjustment.dest_bal%type;  
v_tax_amt        adjustment.tax_amt%type; 
v_bonus_amt      adjustment.bonus_amt%type; 
v_bonus_tax_amt  adjustment.bonus_tax_amt%type; 
v_received_amt   adjustment.received_amt%type; 
v_net_amount     adjustment.net_amount%type; 
v_MoneyTranfer Money_Transfer%ROWTYPE;
v_SrcPartner partner%ROWTYPE;
v_DestPartner partner%ROWTYPE;
v_Creator partner%ROWTYPE;
v_Partner_Activity  Partner_Activity%ROWTYPE;
v_MasterParam  Partner_Activity%ROWTYPE;
v_Params Partner_Activity_Detail%ROWTYPE;
v_AdjustmentMaxDays number;
v_ActualPeriod number;
v_count number;
v_absolute_amount         adjustment.amount%type; 
begin
  
  BEGIN
  if (v_amount = 0) then
    begin
      -- Not Allowed
         return -505;
    end;
  end if;  
  
    select * into v_MoneyTranfer 
    from Money_Transfer 
    where trans_id = v_moneytranferid;
    EXCEPTION
    when no_data_found then
         -- Not Found
         return -500;
  END; 
-------------------------------------------------
if (v_MoneyTranfer.Adjusted = 1 or v_MoneyTranfer.Adjust_Id > 0) then
  begin
     -- Already Adjusted
     return -509;
  end;
end if;
-------------------------------------------------
if (v_amount < 0) then
  v_absolute_amount := -1 * v_amount;
else
  v_absolute_amount :=  v_amount;
end if;
if (v_absolute_amount >   v_MoneyTranfer.Amount) then
  begin
    -- Adjustment amount more than origin transfer amount
    return -510;
  end;
end if;
-------------------------------------------------
BEGIN
    select * into v_SrcPartner 
    from partner 
    where partner_acc = v_MoneyTranfer.Creator_Acc;
    EXCEPTION
    when no_data_found then
         -- Not Found
         return -500;
  END; 
-------------------------------------------------
BEGIN
    select * into v_DestPartner 
    from partner 
    where partner_acc = v_MoneyTranfer.Part_Acc;
    EXCEPTION
    when no_data_found then
         -- Not Found
         return -500;
  END; 
-------------------------------------------------
BEGIN
    select * into v_Creator 
    from partner 
    where partner_acc = v_createdbyacc;
    EXCEPTION
    when no_data_found then
         -- Not Found
         return -500;
  END; 
-------------------------------------------------
BEGIN
    select * into v_Partner_Activity 
    from Partner_Activity
    where act_id = 'Adjustment'
    and fromroleid = v_Creator.Roleid;
    EXCEPTION
    when no_data_found then
         -- Not Allowed
         return -505;
  END; 
-------------------------------------------------
BEGIN
    select nvl(count(*), 0) into v_count
    from Partner_Activity_Detail
    where master_row =  v_Partner_Activity.Row_Id
    and dest_role_id = v_SrcPartner.Roleid;
    
    if (v_count = 0) then
      begin
        -- Not Allowed
          return -505;
      end;
    end if;
    EXCEPTION
    when no_data_found then
         -- Not Allowed
         return -505;
  END; 
-------------------------------------------------
BEGIN
    select * into v_MasterParam 
    from Partner_Activity 
    where act_id = 'MoneyTransfer.Create'
    and fromroleid = v_SrcPartner.Roleid;
    EXCEPTION
    when no_data_found then
         -- Not Allowed
         return -505;
  END; 
-------------------------------------------------

BEGIN
    select * into v_Params 
    from Partner_Activity_Detail 
    where master_row = v_MasterParam.Row_Id
     and dest_role_id = v_DestPartner.Roleid;
    EXCEPTION
    when no_data_found then
         -- Not Allowed
         return -505;
  END; 
-------------------------------------------------      
v_src_bal := pk_utility.fn_getpartnerbalance(v_partner_acc => v_SrcPartner.Partner_Acc);
      if (v_src_bal = -1) then
       begin
           --message := 'inconsistent data';
          return -507;
       end;
      end if; 
      
    v_dest_bal := pk_utility.fn_getpartnerbalance(v_partner_acc => v_DestPartner.Partner_Acc);
      if (v_src_bal = -1) then
       begin
           --message := 'inconsistent data';
          return -507;
       end;
      end if; 
  -------------------------------------------------------
  SELECT trunc(sysdate)-trunc(v_MoneyTranfer.Createdon) into v_ActualPeriod FROM DUAL;
  select nvl((select sett_value   from glogalsettings where sett_code = 'Adjustment.MaxDays'), -1) into v_AdjustmentMaxDays from dual;
  if (v_AdjustmentMaxDays > 0) then
    begin
        if (v_ActualPeriod > v_AdjustmentMaxDays) then
          begin
              -- OutOfDate
              return -508;
          end;
        end if;
    end;
  end if;
  -------------------------------------------------------
  if (v_amount > 0) then
    begin
        if (v_dest_bal < v_amount) then
           begin
               -- balance not enough
               return -501;
           end;
        end if;
    end;
  else
     begin
          if (v_Params.Check_Bal = 1 and (v_src_bal + v_amount) < 0)  then
           begin
               -- balance not enough
               return -501;
           end;
        end if;
     end;
  end if;
                  v_net_amount := v_amount / ((v_Params.Taxper / 100) +1);
                  v_tax_amt :=  v_net_amount * (v_Params.Taxper / 100);
                  v_bonus_amt := v_net_amount * (v_Params.Bonus_Per / 100);
                  v_bonus_tax_amt := v_bonus_amt * (v_Params.Bonus_Tax / 100);
                  v_received_amt := (v_amount -  v_bonus_amt + v_bonus_tax_amt);
                    v_adj_id := seq_adjustement_id.nextval();
                  insert into adjustment
                        (adj_id, createon, createdby, moneytranferid, src_bal, src_role_id, 
                        src_status, src_acc, dest_bal, dest_role_id, dest_status, dest_acc, amount, tax_per, 
                        tax_amt, bonus_per, bonus_amt, bonus_tax, bonus_tax_amt, received_amt, net_amount, 
                        access_channel, note, period_days, createdbyacc, sett_period)
                      values
                        (v_adj_id, sysdate, v_Creator.Partner_Id, v_MoneyTranfer.Trans_Id, v_src_bal, v_SrcPartner.Roleid, 
                        v_SrcPartner.Status, v_SrcPartner.Partner_Acc, v_dest_bal, v_DestPartner.Roleid, v_DestPartner.Status, v_DestPartner.Partner_Acc, v_amount, 
                        v_Params.Taxper, v_tax_amt, v_Params.Bonus_Per, v_bonus_amt, v_Params.Bonus_Tax, v_bonus_tax_amt, v_received_amt, 
                        v_net_amount, v_access_channel, v_note, v_ActualPeriod, v_Creator.Partner_Acc, v_AdjustmentMaxDays);
                    
                      update partner set balance = balance - v_amount where partner_acc = v_DestPartner.Partner_Acc;
                      pk_infra.sp_create_pfr(v_act_time => sysdate,
                         v_partner_acc => v_DestPartner.Partner_Acc,
                         v_amount => -1 * v_amount,
                         v_act_id => 'Adjustment',
                         v_act_no => v_adj_id,
                         v_createdbyacc => v_createdbyacc);
                      
                      update money_transfer set adjusted = 1, adjust_id = v_adj_id where trans_id = v_MoneyTranfer.Trans_Id;
                      
                      if (v_Params.Check_Bal = 1) then
                        begin
                            update partner set balance = balance + v_amount where partner_acc = v_SrcPartner.Partner_Acc;
                            pk_infra.sp_create_pfr(v_act_time => sysdate,
                                       v_partner_acc => v_SrcPartner.Partner_Acc,
                                       v_amount => v_amount,
                                       v_act_id => 'Adjustment',
                                       v_act_no => v_adj_id,
                                       v_createdbyacc => v_createdbyacc);
                        end ;
                      end if;
                      return v_adj_id;
  EXCEPTION

      WHEN OTHERS THEN
         Rollback;
         sp_add_exception(v_exp_code => SQLCODE,
                 v_exp_message => SUBSTR(SQLERRM, 1 , 500),
                 v_exp_operation => 'Create',
                 v_exp_object => 'Adjustment');

         return SQLCODE;
end;


function fn_Create_Collection (
v_subs_no          collection.subs_no%type, 
v_amount           collection.amount%type, 
v_pos_id           collection.pos_id%type, 
v_access_channel   collection.access_channel%type,
v_queue_no         collection.queue_no%type,
v_ref_no           collection.ref_no%type, 
v_ref_message      collection.ref_message%type,  
v_ref_time         collection.ref_time%type,  
v_ref_trans_no     collection.ref_trans_no%type,  
v_debug_info       collection.debug_info%type,
v_status       collection.status%type,
v_api_trans       collection.api_trans%type
) return number is
v_cl_id            collection.cl_id%type;
v_pos_bal  collection.pos_bal%type;
v_pos_acc  collection.pos_acc%type;
v_clDraft_id     collection_Draft.Row_Id%type;
v_role number;
v_PartnerStatus partner.status%type;
v_HasPermission number := 0;
v_tmp number := 0;
v_Min_Value partner_activity_detail.min_value%TYPE;
v_Max_Value partner_activity_detail.max_value%TYPE;
 v_creator_role_id money_transfer.creator_role_id%TYPE;
begin
 
  v_pos_acc := pk_utility.fn_GetActiveAccount(v_pos_id);
  if (v_pos_acc <= 0) then
    begin
        -- incorrect partner
        return -511;
    end;
  end if;
  
  v_role := pk_utility.fn_GetPartnerRole(v_pos_acc);
  if (v_role <= 0) then
    begin
        -- Unauthorized
        return -513;
    end;
  end if;
  
  v_HasPermission := pk_utility.fn_IsPartnerActivityDefined('Recharge.Create', v_role, 9);
  if (v_HasPermission <> 1) then
    begin
        -- Unauthorized
        return -513;
    end;
  end if;
  
   v_PartnerStatus := pk_utility.fn_GetPartnerStatus(v_pos_acc);
    if (v_PartnerStatus > 2) then
    begin
        -- Incorrect state
        return -512;
    end;
  end if;
  v_pos_bal := pk_utility.fn_GetPartnerBalance(v_pos_acc);
      if (v_pos_bal < v_amount) then
    begin
        -- balance not enough
        return -501;
    end;
  end if;
  
     if (v_access_channel = 'api') then
       begin
           select  nvl(count(*),0) into v_tmp from collection where collection.pos_acc = v_pos_acc and api_trans = v_api_trans and access_channel = 'api';
           if (v_tmp > 0) then
             begin
                return -514;
             end;
           end if;
       end;
     end if;
  
     select nvl(Min_Value,0) into v_Min_Value from v_partner_activity_detail where act_id = 'Recharge.Create' and fromroleid = v_role and toroleid = 9;
     select nvl(Max_Value,0) into v_Max_Value from v_partner_activity_detail where act_id = 'Recharge.Create' and fromroleid = v_role and toroleid = 9;
    if (v_Min_Value > v_amount) then
       begin
           --message := 'Amount less than minimum';
           return -502;
       end;
        end if;  
      
      if (v_Max_Value < v_amount) then
       begin
           --message := 'Amount more than maximum';
           return -503;
       end;
        end if;  
  v_cl_id := seq_collection_id.nextval();
  insert into collection
  (cl_id, createdon, subs_no, amount, pos_id, pos_acc, pos_bal, access_channel, status, status_time, queue_no, ref_no, 
  ref_message, ref_time, ref_trans_no, debug_info, api_trans)
values
  (v_cl_id, sysdate, v_subs_no, v_amount, v_pos_id, v_pos_acc, v_pos_bal, v_access_channel, v_status, sysdate,
   v_queue_no, v_ref_no, v_ref_message, v_ref_time, v_ref_trans_no, v_debug_info, v_api_trans);
   
   update partner set reserved = reserved + v_amount where partner_acc = v_pos_acc;
   
   if (v_access_channel = 'sms') then
     begin
         v_clDraft_id := seq_collection_draft_id.nextval();
         insert into collection_draft
          (row_id, ref_no, queue_no, access_channel, createdon)
        values
          (v_clDraft_id, v_cl_id, v_queue_no, v_access_channel, sysdate);
     end;
   end if;
return v_cl_id;

 EXCEPTION
      WHEN OTHERS THEN
         Rollback;
         sp_add_exception(v_exp_code => SQLCODE,
                 v_exp_message => SUBSTR(SQLERRM, 1 , 500),
                 v_exp_operation => 'Create',
                 v_exp_object => 'Collection');

         return SQLCODE;
end;

function fn_Update_Collection (
v_cl_id            collection.cl_id%type,
v_status         collection.status%type,
v_ref_no           collection.ref_no%type, 
v_ref_message      collection.ref_message%type,  
v_ref_time         collection.ref_time%type,  
v_ref_trans_no     collection.ref_trans_no%type,  
v_debug_info       collection.debug_info%type,
v_update_bal  number
) return number is
v_CollectionRow Collection%ROWTYPE;
v_pos_bal  collection.pos_bal%type;
v_tmp number;
v_currentBalance number;
begin
 
   BEGIN
        select * into v_CollectionRow 
        from collection 
        where  cl_id = v_cl_id;
        EXCEPTION
        when no_data_found then
             -- Not Allowed
             return -505;
   END; 

  v_pos_bal := pk_utility.fn_GetPartnerBalance(v_CollectionRow.Pos_Acc);
      if (v_pos_bal < v_CollectionRow.Amount) then
    begin
        -- balance not enough
        if (v_status = 1) then
          begin
             update collection
              set 
               pos_bal = v_pos_bal,
               status = 3,
               status_time = sysdate,
               ref_no = v_ref_no,
               ref_message = v_ref_message,
               ref_time = v_ref_time,
               ref_trans_no = v_ref_trans_no,
               debug_info = '-501-balance not enough'
                where cl_id = v_cl_id; 
                 return -501;
          end;    
          end if;       
    end;
  end if;
  
  update collection
   set 
       pos_bal = v_pos_bal,
       status = v_status,
       status_time = sysdate,
       ref_no = v_ref_no,
       ref_message = v_ref_message,
       ref_time = v_ref_time,
       ref_trans_no = v_ref_trans_no,
       debug_info = v_debug_info
   where cl_id = v_cl_id;

   delete from collection_draft where ref_no = v_cl_id;

   
   if (v_update_bal = 1 and v_status = 1) then
     begin
       select nvl(balance,0) into v_currentBalance from partner where partner_acc= v_CollectionRow.Pos_Acc;
        update partner set balance = balance - v_CollectionRow.Amount, reserved = reserved - v_CollectionRow.Amount where partner_acc= v_CollectionRow.Pos_Acc;
        
          pk_infra.sp_create_pfr(v_act_time => sysdate,
                         v_partner_acc => v_CollectionRow.Pos_Acc,
                         v_amount => -1 * v_CollectionRow.Amount,
                         v_act_id => 'Recharge.Create',
                         v_act_no => v_cl_id,
                         v_createdbyacc => v_CollectionRow.Subs_No);
                         
          v_tmp := pk_infra.fn_createoutsms(v_message => '   ' 
          ||  rtrim(ltrim(to_char(v_CollectionRow.Amount,'999,999,999,999')))
          || '     ',
          v_receiver => v_CollectionRow.Subs_No);
          
          if (v_CollectionRow.Access_Channel = 'sms') then
            begin
                   v_tmp := pk_infra.fn_createoutsms(v_message => '   ' 
                   || v_CollectionRow.Subs_No 
                   || '  ' 
                   ||   rtrim(ltrim(to_char(v_CollectionRow.Amount,'999,999,999,999')))
                   || '   '
                   ||  rtrim(ltrim(to_char(v_pos_bal,'999,999,999,999'))),
                   v_receiver => v_CollectionRow.Pos_Id);              
            end;
          end if;
           
           
     end;
   else if (v_update_bal = 1 and v_status = 2) then
     begin
        update partner set reserved = reserved - v_CollectionRow.Amount where partner_acc= v_CollectionRow.Pos_Acc;
          if (v_CollectionRow.Access_Channel = 'sms') then
            begin
                   v_tmp := pk_infra.fn_createoutsms(v_message => '    '
                     || v_CollectionRow.Subs_No 
                     || '  ' 
                     ||   rtrim(ltrim(to_char(v_CollectionRow.Amount,'999,999,999,999'))) 
                     || '   '
                     ||  rtrim(ltrim(to_char(v_pos_bal,'999,999,999,999'))),
                     v_receiver => v_CollectionRow.Pos_Id);              
            end;
          end if;
     end;
   end if;
   end if;
   
   return v_cl_id;

 EXCEPTION
      WHEN OTHERS THEN
         Rollback;
         sp_add_exception(v_exp_code => SQLCODE,
                 v_exp_message => SUBSTR(SQLERRM, 1 , 500),
                 v_exp_operation => 'Update',
                 v_exp_object => 'Collection');

         return SQLCODE;
end;

function fn_Create_Confiscation(
v_createdby    confiscation.createdby%type,     
v_createdbyacc confiscation.createdbyacc%type,
v_partner_id   confiscation.partner_id%type,  
v_partner_acc  confiscation.partner_acc%type  , 
v_note         confiscation.note%type        ) return number is

v_con_id confiscation.con_id%type;
v_currBalance      confiscation.balance%type;
begin

   v_currBalance := pk_utility.fn_GetPartnerBalance(v_partner_acc => v_partner_acc);
   v_con_id := seq_confiscation_id.nextval();

    insert into confiscation
        (con_id, createdon, createdby, createdbyacc, partner_id, partner_acc, balance, note)
      values
        (v_con_id, sysdate, v_createdby, v_createdbyacc, v_partner_id, v_partner_acc, v_currBalance, v_note);
     update partner set balance = balance - v_currBalance where partner_acc = v_partner_acc;
     pk_infra.sp_create_pfr(v_act_time => sysdate,
                                       v_partner_acc => v_partner_acc,
                                       v_amount => -1 * v_currBalance,
                                       v_act_id => 'Partner.Confiscate',
                                       v_act_no => v_con_id,
                                       v_createdbyacc => v_createdbyacc);
     return v_con_id;
     

  EXCEPTION
      WHEN OTHERS THEN
         Rollback;
         sp_add_exception(v_exp_code => SQLCODE,
                 v_exp_message => SUBSTR(SQLERRM, 1 , 500),
                 v_exp_operation => 'Create',
                 v_exp_object => 'Confiscation');

         return SQLCODE;
end;

function fn_BalanceOfPointOfTime(account number , specificTime date ) return number is
    tmp number;
  begin
    select sum(nvl(amount,0)) into tmp from pfinrec where pfinrec.partner_acc = account and pfinrec.createdon <= specificTime;
     return nvl(tmp,0); 
  end;
  
function fn_Generate_PFR(
    account number,
    startDate date,
    endDate date) return number is
      
      lastAmount number;
      
      CURSOR c_pfr is
      select * from v_pfr p where p.partner_acc = account and p.createdon >= startDate and p.createdon <= endDate order by p.createdon;
      
       pfrRow c_pfr%rowtype;
       
begin
      
        delete from pfr_online  t where t.partner_acc = account;
        
        select sum(nvl(amount,0)) into lastAmount from pfinrec  t where t.partner_acc = account and t.createdon < startDate;
        DBMS_OUTPUT.PUT_LINE('lastAmount = ' || lastAmount || '   ' || startDate || '   ' || account); 
        insert into pfr_online
            (bal, pfr_id, createdon, partner_acc, partner_id, amount, act_id, act_name, act_no, createdbyacc, creatorbyid, creatorbyname, act_time, generatedon)
          values
            (nvl(lastAmount,0), 0, TO_DATE(startDate - 1)  , account, null, nvl(lastAmount,0), null, ' ', null, null, null, null, null, sysdate);

        OPEN c_pfr;
        
        LOOP
          
             FETCH  c_pfr  INTO pfrRow;
             
             EXIT WHEN c_pfr%NOTFOUND;
             
             lastAmount := nvl(lastAmount,0) + pfrRow.Amount;
             
              insert into pfr_online
                  (bal, pfr_id, createdon, partner_acc, partner_id, amount, act_id, act_name, act_no, createdbyacc, creatorbyid, creatorbyname, act_time, generatedon)
                values
                  (nvl(lastAmount,0), pfrRow.Pfr_Id, pfrRow.Createdon, pfrRow.Partner_Acc, pfrRow.Partner_Id, nvl(pfrRow.Amount,0), pfrRow.Act_Id, pfrRow.Act_Name,pfrRow.Act_No, pfrRow.Createdbyacc, pfrRow.Creatorbyid, pfrRow.Creatorbyname, pfrRow.Act_Time, sysdate);
                  
        END LOOP;
        
        CLOSE c_pfr;
        
        return 1;
        
end;

END pk_financial;
/

prompt
prompt Creating package body PK_INFRA
prompt ==============================
prompt
create or replace package body pk_infra is

  
function fn_CreatePartner (
v_partner_id           partner.partner_id%type, 
v_partner_name      partner.partner_name%type,
v_brandname          partner.brandname%type,
v_roleid                    partner.roleid%type, 
v_id_no                     partner.id_no%type, 
v_id_type                   partner.id_type%type, 
v_id_place                  partner.id_place%type,
v_id_issued                 partner.id_issued%type, 
v_createdby                 partner.createdby%type, 
v_cityid                    partner.cityid%type, 
v_districtid                partner.districtid%type, 
v_street                    partner.street%type, 
v_zone                      partner.zone%type, 
v_extra_address             partner.extra_address%type, 
v_pair_mobile               partner.pair_mobile%type, 
v_mobile                    partner.mobile%type, 
v_fixed                     partner.fixed%type, 
v_fax                       partner.fax%type, 
v_email                     partner.email%type, 
v_pwd                       partner.pwd%type, 
v_extra                     partner.extra%type, 
v_ip_address            partner.ip_address%type,
v_ref_partner            partner.ref_partner%type
   
  ) return number is
    v_partnerActivityFound number := 0;
    v_partner_acc               partner.partner_acc%type;
    v_creator_acc               partner.partner_acc%type;
    v_creator_role               partner.roleid%type;
    v_Permission                partner_activity%rowtype;
    v_PermissionDetail       partner_activity_detail%rowtype;
    v_Id_exists   number := 0;
    v_lastRef_partner            partner.ref_partner%type;
  BEGIN
    
     select nvl(count(*),0) into v_Id_exists from partner where partner_id = v_partner_id and (status < 4);
     if (v_Id_exists > 0) then
       begin
           --message := 'Duplicated';
          return -504;
       end;
      end if;  
      v_creator_acc := pk_utility.fn_getactiveaccount(v_partner_id => v_createdby);
       if (v_creator_acc < 0) then
       begin
           --message := 'Not Found';
          return -500;
       end;
      end if;  
      v_creator_role := pk_utility.fn_getpartnerrole(v_partner_acc => v_creator_acc);
      if (v_creator_acc < 0) then
       begin
           --message := 'Not Found';
          return -500;
       end;
      end if;  
       v_partnerActivityFound := pk_utility.fn_ispartneractivitydefined(v_act_id => 'Partner.Create',
                                                    v_fromroleid => v_creator_role,
                                                    v_toroleid => v_roleid);
        if (v_partnerActivityFound <> 1) then
       begin
           --message := 'Unauthrized';
          return -513;
       end;
      end if;
     v_lastRef_partner := v_ref_partner;
     select * into v_permission from partner_activity  p where p.act_id =  'Partner.Create' and p.fromroleid = v_creator_role;
     select * into v_PermissionDetail from partner_activity_detail  p where p.master_row =  v_permission.row_id and p.dest_role_id = v_roleid;
     if (v_permission.act_scope = 'CurOpOnly') then
       begin
            return -513;
       end;
     else if  (v_permission.act_scope = 'Exclusive') then
       begin
         v_lastRef_partner := v_createdby;
       end;
       end if;
     end if;
  
     v_partner_acc := seq_partner_acc.nextval() + 100;
     
    insert into partner
       (partner_id, partner_name, brandname, balance, reserved, verificationcodenext, locktime, roleid, id_no, id_type, id_place
       , id_issued, status, statuson, statusby, createdon, createdby, cityid, districtid, street, zone, extra_address, pair_mobile, mobile
       , fixed, fax, email, pwd, extra, wrong_pwd_attempts, last_login, ip_address, partner_acc, ref_partner)
   values
      (v_partner_id, v_partner_name, v_brandname, 0, 0, 1, null, v_roleid, v_id_no, v_id_type, v_id_place
       , v_id_issued, 1, sysdate, v_createdby, sysdate, v_createdby, v_cityid, v_districtid, v_street, v_zone, v_extra_address, v_pair_mobile, v_mobile
       , v_fixed, v_fax, v_email, v_pwd, v_extra, 0, null, v_ip_address, v_partner_acc, v_lastRef_partner);
       
       return v_partner_acc;
       
EXCEPTION
      WHEN OTHERS THEN
         sp_add_exception(v_exp_code => SQLCODE,
                 v_exp_message => SUBSTR(SQLERRM, 1 , 500),
                 v_exp_operation => 'Create',
                 v_exp_object => 'Partner');
         return SQLCODE;
  END;

function fn_UpdatePartner (
v_partner_name              partner.partner_name%type,
v_brandname                 partner.brandname%type,
v_roleid                    partner.roleid%type, 
v_id_no                     partner.id_no%type, 
v_id_type                   partner.id_type%type, 
v_id_place                  partner.id_place%type,
v_id_issued                 partner.id_issued%type, 
v_createdby                 partner.createdby%type, 
v_cityid                    partner.cityid%type, 
v_districtid                partner.districtid%type, 
v_street                    partner.street%type, 
v_zone                      partner.zone%type, 
v_extra_address             partner.extra_address%type, 
v_pair_mobile               partner.pair_mobile%type, 
v_mobile                    partner.mobile%type, 
v_fixed                     partner.fixed%type, 
v_fax                       partner.fax%type, 
v_email                     partner.email%type, 
v_ip_address                partner.ip_address%type,
v_partner_acc               partner.partner_acc%type,
v_ref_partner   partner.ref_partner%type
   
  ) return number is
    v_partnerActivityFound number := 0;
    v_creator_acc               partner.partner_acc%type;
    v_creator_role               partner.roleid%type;
    v_Id_exists   number := 0;
    v_old_role_id partner.roleid%type;
    v_Permission                partner_activity%rowtype;
    v_PermissionDetail       partner_activity_detail%rowtype;
     v_editPartner partner%rowtype;
  BEGIN
    --------------------------------------------------------------------------
    -- check permission
    v_creator_acc := pk_utility.fn_getactiveaccount(v_partner_id => v_createdby);
       if (v_creator_acc < 0) then
       begin
           --message := 'Not Found';
          return -500;
       end;
      end if;  
      v_creator_role := pk_utility.fn_getpartnerrole(v_partner_acc => v_creator_acc);
      if (v_creator_acc < 0) then
       begin
           --message := 'Not Found';
          return -500;
       end;
      end if;  
       v_partnerActivityFound := pk_utility.fn_ispartneractivitydefined(v_act_id => 'Partner.Edit',
                                                    v_fromroleid => v_creator_role,
                                                    v_toroleid => v_roleid);
        if (v_partnerActivityFound <> 1) then
       begin
           --message := 'Unauthrized';
          return -513;
       end;
      end if;
    ---------------------------------------------------------------------------  
  
  
     select nvl(count(*),0) into v_Id_exists from partner where partner_acc = v_partner_acc;
     select roleid into v_old_role_id from partner where partner_acc = v_partner_acc;
     
     if (v_Id_exists = 0 or v_old_role_id = 0 or v_old_role_id is null) then
       begin
           --message := 'Not Found';
          return -500;
       end;
      end if;  
    if (v_old_role_id <>  v_roleid) then
      begin
         --message := 'Not All';
          return -505;
       end;
       end if;
        select * into v_editPartner from partner where partner_acc = v_partner_acc;
     select * into v_permission from partner_activity  p where p.act_id =  'Partner.Edit' and p.fromroleid = v_creator_role;
     select * into v_PermissionDetail from partner_activity_detail  p where p.master_row =  v_permission.row_id and p.dest_role_id = v_roleid;
     if (v_permission.act_scope = 'CurOpOnly' and v_editPartner.Partner_Id <> v_createdby) then
       begin
            return -513;
       end;
     else if  (v_permission.act_scope = 'Exclusive'  and v_editPartner.Ref_Partner <> v_createdby ) then
       begin
          return -513;
       end;
       end if;
     end if;



update partner
   set  partner_name = v_partner_name,
       brandname = v_brandname,
       roleid = v_roleid,
       id_no = v_id_no,
       id_type = v_id_type,
       id_place = v_id_place,
       id_issued = v_id_issued,
       cityid = v_cityid,
       districtid = v_districtid,
       street = v_street,
       zone = v_zone,
       extra_address = v_extra_address,
       pair_mobile = v_pair_mobile,
       mobile = v_mobile,
       fixed = v_fixed,
       fax = v_fax,
       email = v_email,
       ip_address = v_ip_address,
       ref_partner = v_ref_partner
 where partner_acc = v_partner_acc;     
       return 1;
EXCEPTION
      WHEN OTHERS THEN
         sp_add_exception(v_exp_code => SQLCODE,
                 v_exp_message => SUBSTR(SQLERRM, 1 , 500),
                 v_exp_operation => 'Update',
                 v_exp_object => 'Partner');
         return SQLCODE;
  END;

function fn_deletePartner(
  v_partner_acc partner.partner_acc%type, 
  v_createdby partner.partner_id%type
  ) return number is
  v_IsIdle number;
   v_partnerActivityFound number := 0;
    v_creator_acc               partner.partner_acc%type;
    v_creator_role               partner.roleid%type;
    v_deletedPartner partner%rowtype;
  begin
    select * into v_deletedPartner from partner where partner_acc = v_partner_acc;
   --------------------------------------------------------------------------
    -- check permission
    v_creator_acc := pk_utility.fn_getactiveaccount(v_partner_id => v_createdby);
       if (v_creator_acc < 0) then
       begin
           --message := 'Not Found';
          return -500;
       end;
      end if;  
      v_creator_role := pk_utility.fn_getpartnerrole(v_partner_acc => v_creator_acc);
      if (v_creator_acc < 0) then
       begin
           --message := 'Not Found';
          return -500;
       end;
      end if;  
       v_partnerActivityFound := pk_utility.fn_ispartneractivitydefined(v_act_id => 'Partner.Delete',
                                                    v_fromroleid => v_creator_role,
                                                    v_toroleid => v_deletedPartner.Roleid);
      if (v_partnerActivityFound <> 1) then
       begin
           --message := 'Unauthrized';
          return -513;
       end;
      end if;
    ---------------------------------------------------------------------------  
  
      v_IsIdle := pk_utility.fn_isidlepartner(v_partner_acc => v_partner_acc);
      if (v_IsIdle <> 1) then
        begin
          -- not allowed
           return -505;
        end;
      end if;
      
      
      delete from partner where partner_acc = v_partner_acc;
      return 1;
   EXCEPTION
        WHEN OTHERS THEN
          return -1;       
  end;


function fn_createOutSMS( 
v_message   sms_out.message%type, 
v_receiver  sms_out.receiver%type) return number is
v_row_id sms_out.receiver%type;
v_sender   sms_out.sender%type;
begin
select nvl((select sett_value   from glogalsettings where sett_code = 'Sender'), -1) into v_sender from dual;  

v_row_id := seq_sms_out_id.nextval();
insert into sms_out
  (row_id, sender, message, receiver, createdon)
values
  (v_row_id, 
  v_sender, 
  v_message, 
  v_receiver, 
  sysdate);
  return v_row_id;
EXCEPTION
      WHEN OTHERS THEN
         sp_add_exception(v_exp_code => SQLCODE,
                 v_exp_message => SUBSTR(SQLERRM, 1 , 500),
                 v_exp_operation => 'Create',
                 v_exp_object => 'sms_Out');
         return SQLCODE;
end;

function fn_ResetPassword(
  v_partner_acc               partner.partner_acc%type,
  v_pwd                       partner.pwd%type, 
   v_extra                     partner.extra%type,
   v_createdby   partner.partner_id%type
  ) return number is 
      v_partnerActivityFound number := 0;
       v_creator_acc               partner.partner_acc%type;
        v_creator_role               partner.roleid%type;
          v_targetPartner partner%rowtype;
  Begin
    
   --------------------------------------------------------------------------
    -- check permission
    v_creator_acc := pk_utility.fn_getactiveaccount(v_partner_id => v_createdby);
       if (v_creator_acc < 0) then
       begin
           --message := 'Not Found';
          return -500;
       end;
      end if;  
      select * into v_targetPartner from partner where partner_acc = v_partner_acc;
      v_creator_role := pk_utility.fn_getpartnerrole(v_partner_acc => v_creator_acc);
      if (v_creator_acc < 0) then
       begin
           --message := 'Not Found';
          return -500;
       end;
      end if;  
       v_partnerActivityFound := pk_utility.fn_ispartneractivitydefined(v_act_id => 'Partner.ResetPassword',
                                                    v_fromroleid => v_creator_role,
                                                    v_toroleid => v_targetPartner.Roleid);
        if (v_partnerActivityFound <> 1) then
       begin
           --message := 'Unauthrized';
          return -513;
       end;
      end if;
    ---------------------------------------------------------------------------  
  
    update partner 
    set pwd = v_pwd,   extra = v_extra
    where partner_acc = v_partner_acc;
    return 1;
  
  
    EXCEPTION
      WHEN OTHERS THEN
         sp_add_exception(v_exp_code => SQLCODE,
                 v_exp_message => SUBSTR(SQLERRM, 1 , 500),
                 v_exp_operation => 'Create',
                 v_exp_object => 'sms_Out');
         return SQLCODE;
  end;
  
  
  function fn_ChangePassword(
  v_partner_acc               partner.partner_acc%type,
  v_pwd                       partner.pwd%type, 
   v_extra                     partner.extra%type
  ) return number is 
      v_partnerActivityFound number := 0;
       v_creator_acc               partner.partner_acc%type;
        v_creator_role               partner.roleid%type;
          v_targetPartner partner%rowtype;
  Begin
   
/* 
      v_partnerActivityFound := pk_utility.fn_ispartneractivitydefined(v_act_id => 'Partner.ResetPassword',
                                                    v_fromroleid => v_creator_role,
                                                    v_toroleid => v_targetPartner.Roleid);
        if (v_partnerActivityFound <> 1) then
       begin
           --message := 'Unauthrized';
          return -513;
       end;
      end if;
    ---------------------------------------------------------------------------  
  */
    update partner 
    set pwd = v_pwd,   extra = v_extra
    where partner_acc = v_partner_acc;
    return 1;
  
  
    EXCEPTION
      WHEN OTHERS THEN
         sp_add_exception(v_exp_code => SQLCODE,
                 v_exp_message => SUBSTR(SQLERRM, 1 , 500),
                 v_exp_operation => 'Change Pass',
                 v_exp_object => 'Change');
         return SQLCODE;
  end;

  
 function fn_create_in_sms(
    v_reciever sms_in.reciever%type, 
    v_sender sms_in.sender%type, 
    v_message sms_in.message%type,
    v_ref_no sms_in.ref_no%type,
     v_lang sms_in.lang%type
    ) return number is
    v_in_id sms_in.in_no%type;
    begin
      v_in_id := seq_sms_in_id.nextval();
      insert into sms_in
          (in_no, reciever, sender, message, createdon, ref_no, lang)
        values
          (v_in_id, v_reciever, v_sender, v_message, sysdate, v_ref_no, v_lang);
          return v_in_id;
     EXCEPTION
      WHEN OTHERS THEN
         sp_add_exception(v_exp_code => SQLCODE,
                 v_exp_message => SUBSTR(SQLERRM, 1 , 500),
                 v_exp_operation => 'Create',
                 v_exp_object => 'sms_in');
         return SQLCODE;    
    end;
 
     function fn_Create_Partner_Request(
   v_req_id partner_request.req_id%type, 
  v_req_content partner_request.req_content%type, 
  v_replay_time partner_request.replay_time%type, 
  v_replay_desc partner_request.replay_desc%type, 
  v_replay_shortcode partner_request.replay_shortcode%type, 
  v_status partner_request.status%type, 
  v_queue_no partner_request.queue_no%type,
  v_error partner_request.error%type,
  v_accesschannel partner_request.accesschannel%type
  ) return number is
  v_req_row_no partner_request.req_row_no%type;
  begin
    v_req_row_no := seq_partner_req_id.nextval();
    insert into partner_request
        (req_row_no, createdon, req_id, req_content, replay_time, replay_desc, replay_shortcode, status, queue_no, error, accesschannel)
      values
        (v_req_row_no, sysdate, v_req_id, v_req_content, v_replay_time, v_replay_desc, v_replay_shortcode, v_status, v_queue_no, v_error, v_accesschannel);
        return v_req_row_no;
     EXCEPTION
      WHEN OTHERS THEN
         sp_add_exception(v_exp_code => SQLCODE,
                 v_exp_message => SUBSTR(SQLERRM, 1 , 500),
                 v_exp_operation => 'Create',
                 v_exp_object => 'Partner Request');
         return SQLCODE;    
  end;
  
    function fn_Create_PartnerStatus_log(
    v_createdby           PARTNER_STATUS_LOG.createdby%type,         
  v_createdbyacc        PARTNER_STATUS_LOG.createdbyacc%type,      
  v_partner_id          PARTNER_STATUS_LOG.partner_id%type,        
  v_partner_acc         PARTNER_STATUS_LOG.partner_acc%type,       
  v_old_status          PARTNER_STATUS_LOG.old_status%type,        
  v_new_status          PARTNER_STATUS_LOG.new_status%type,        
  v_note                PARTNER_STATUS_LOG.note%type,              
  v_newstatus_expireon  PARTNER_STATUS_LOG.newstatus_expireon%type
  ) return number is
  v_log_id PARTNER_STATUS_LOG.LOG_ID%type;
  begin
    v_log_id := seq_partner_status_log_id.nextval();
    insert into partner_status_log
        (log_id, createdon, createdby, createdbyacc, partner_id, partner_acc, old_status, new_status, note, newstatus_expireon)
      values
        (v_log_id, sysdate, v_createdby, v_createdbyacc, v_partner_id, v_partner_acc, v_old_status, v_new_status, v_note, v_newstatus_expireon);
        
        update partner set status = v_new_status, statuson = sysdate, statusby = v_createdby
        where partner_acc = v_partner_acc;
        
     return v_log_id;
  
  EXCEPTION
      WHEN OTHERS THEN
         sp_add_exception(v_exp_code => SQLCODE,
                 v_exp_message => SUBSTR(SQLERRM, 1 , 500),
                 v_exp_operation => 'Create',
                 v_exp_object => 'Partner Status Change');
         return SQLCODE;    
  end;
  
  function fn_Create_SMSOne (
  v_createdby    SEND_SMSONE_HIS.createdby%type,
  v_createdbyacc SEND_SMSONE_HIS.createdbyacc%type,
  v_receiver     SEND_SMSONE_HIS.receiver%type,
  v_msg          SEND_SMSONE_HIS.msg%type,
  v_note         SEND_SMSONE_HIS.note%type
  ) return number is
     v_sms_id       SEND_SMSONE_HIS.sms_id%type;
      v_sender   sms_out.sender%type;
      v_smsOutInsertResult number;
  begin

      select nvl((select sett_value   from glogalsettings where sett_code = 'Sender'), -1) into v_sender from dual;  
      if (v_sender = '-1') then
        begin
          return -514;
          -- required data not defined
        end;
      end if;
      
      v_sms_id := seq_smsone_id.nextval();
      
      insert into send_smsone_his
      (sms_id, createdon, createdby, createdbyacc, receiver, shortcode, msg, note)
       values
       (v_sms_id, sysdate, v_createdby, v_createdbyacc, v_receiver, v_sender, v_msg, v_note);

       v_smsOutInsertResult := pk_infra.fn_createoutsms(v_message => v_msg,
                                      v_receiver => v_receiver);
      return v_sms_id;
  EXCEPTION
      WHEN OTHERS THEN
         sp_add_exception(v_exp_code => SQLCODE,
                 v_exp_message => SUBSTR(SQLERRM, 1 , 500),
                 v_exp_operation => 'Create',
                 v_exp_object => 'SendSMSOne');
         return SQLCODE;    
  end;
  
    procedure sp_Create_PFR (
    v_act_time    PFINREC.act_time%type,
    v_partner_acc  PFINREC.partner_acc%type,
    v_amount       PFINREC.amount%type,
    v_act_id       PFINREC.act_id%type,
    v_act_no       PFINREC.act_no%type,
    v_createdbyacc PFINREC.createdbyacc%type
    ) is
    v_pfr_id       PFINREC.pfr_id%type;
    begin
      v_pfr_id := seq_pfr_id.nextval();
      
      insert into pfinrec
        (pfr_id, createdon, partner_acc, amount, act_id, act_no, createdbyacc, act_time)
      values
        (v_pfr_id, sysdate, v_partner_acc, v_amount, v_act_id, v_act_no, v_createdbyacc, v_act_time);
      
      if (v_act_id = 'MoneyTransfer.Create') then
        begin
          update money_transfer  set   pfr = pfr + 1    where trans_id = v_act_no;
        end;
      else  if (v_act_id = 'Recharge.Create') then
        begin
            update collection set  pfr = pfr + 1   where  cl_id = v_act_no;
        end;
      else  if (v_act_id = 'MoneyTransfer.Adjustment') then
        begin
            update adjustment  set  pfr = pfr + 1    where adj_id  = v_act_no;
        end;
       else  if (v_act_id = 'Partner.Confiscate') then
        begin
            update confiscation  set pfr = pfr + 1    where con_id  = v_act_no;
        end;
      end if;  end if; end if; end if; 
      
      
      EXCEPTION
      WHEN OTHERS THEN
         sp_add_exception(v_exp_code => SQLCODE,
                 v_exp_message => SUBSTR(SQLERRM, 1 , 500),
                 v_exp_operation => 'Create',
                 v_exp_object => 'PFR');
    end;
    
    
  function fn_Create_Notification(
     v_partner_id  notification.partner_id%type ,   
      v_notify_msg  notification.notify_msg%type ,
      v_act_id      notification.act_id%type     ,
      v_ref_no      notification.ref_no%type   
   ) return number is 
   
   v_nf_id       notification.nf_id%type;
   v_partner_acc notification.partner_acc%type;
   v_result number;
   begin
     
     v_partner_acc :=  pk_utility.fn_getactiveaccount(v_partner_id => v_partner_id);
   
      
   v_nf_id := seq_notification_id.nextval();
   insert into notification
      (nf_id, createdon, partner_id, partner_acc, notify_msg, act_id, ref_no)
    values
      (v_nf_id, sysdate, v_partner_id, v_partner_acc, v_notify_msg, v_act_id, v_ref_no);

     v_result := pk_infra.fn_createoutsms(v_message => v_notify_msg,
                                      v_receiver => v_partner_id);
    
   return v_nf_id;
   
    EXCEPTION
      WHEN OTHERS THEN
         sp_add_exception(v_exp_code => SQLCODE,
                 v_exp_message => SUBSTR(SQLERRM, 1 , 500),
                 v_exp_operation => 'Create',
                 v_exp_object => 'Notification');
         return SQLCODE;    
   end;
   
   
   function fn_Create_bgService(
     v_createdby     bg_service.createdby%type    ,
     v_createdbyacc  bg_service.createdbyacc%type ,
     v_bg_source     bg_service.bg_source%type    ,
     v_partner_id    bg_service.partner_id%type   ,
      v_partner_acc   bg_service.partner_acc%type,
     v_start_date    bg_service.start_date%type   ,
     v_end_date      bg_service.end_date%type  ,
      v_note      bg_service.note%type   ,
       v_active_time     bg_service.active_time%type,
       v_service_name    bg_service.service_name%type
     ) return number is
     v_bg_id         bg_service.bg_id%type;
    
     begin
       v_bg_id := seq_bdservice_id.nextval();
     insert into bg_service
        (bg_id, createdon, createdby, createdbyacc, bg_source, partner_id, partner_acc, 
        start_date, end_date, record_count, status, status_time, duration_sec, note, active_time, service_name)
      values
        (v_bg_id, sysdate, v_createdby, v_createdbyacc, v_bg_source, v_partner_id, v_partner_acc, 
        v_start_date, v_end_date, 0, 'pending', sysdate, 0, v_note, v_active_time, v_service_name);
       return v_bg_id;
       
       EXCEPTION
      WHEN OTHERS THEN
         sp_add_exception(v_exp_code => SQLCODE,
                 v_exp_message => SUBSTR(SQLERRM, 1 , 500),
                 v_exp_operation => 'Create',
                 v_exp_object => 'bgService');
         return SQLCODE;    
     end;
     
   function fn_Update_bgService(
     v_bg_id         bg_service.bg_id%type     ,
      v_record_count  bg_service.record_count%type ,
      v_file_name     bg_service.file_name%type    ,
      v_file_location bg_service.file_location%type,
      v_status        bg_service.status%type       ,
      v_status_time   bg_service.status_time%type  ,
      v_duration_sec  bg_service.duration_sec%type ,
       v_file_size    bg_service.file_size%type   
     ) return number is
     begin
       update bg_service
           set  record_count = v_record_count,
               file_name = v_file_name,
               file_location = v_file_location,
               status = v_status,
               status_time = v_status_time,
               duration_sec = v_duration_sec,
               file_size = v_file_size
         where bg_id = v_bg_id;
        return 1;
     EXCEPTION
      WHEN OTHERS THEN
         sp_add_exception(v_exp_code => SQLCODE,
                 v_exp_message => SUBSTR(SQLERRM, 1 , 500),
                 v_exp_operation => 'Update',
                 v_exp_object => 'bgService');
         return SQLCODE;   
     end;
     
  function fn_bgService_processing_start (
     v_bg_id         bg_service.bg_id%type,
     v_setActualTime  number
 ) return number is
 begin
   if (v_setActualTime = 1) then
     begin
       update bg_service
       set status = 'processing',
       status_time = sysdate,
       actual_start_time = sysdate
        where bg_id = v_bg_id;
     end;
  else 
    begin
      update bg_service
       set status = 'processing',
       status_time = sysdate
        where bg_id = v_bg_id;
    end;
  end if;
    return v_setActualTime;
   EXCEPTION
      WHEN OTHERS THEN
         sp_add_exception(v_exp_code => SQLCODE,
                 v_exp_message => SUBSTR(SQLERRM, 1 , 500),
                 v_exp_operation => 'Update',
                 v_exp_object => 'bgService_processing_start');
         return SQLCODE;         
 end;
    
 function fn_UpdateBgServActualStartTime (
   v_bg_id         bg_service.bg_id%type,
   v_actual_start_time         bg_service.actual_start_time%type
   ) return number is 
   begin
       update bg_service
       set actual_start_time = v_actual_start_time
        where bg_id = v_bg_id;
        return 1;
       EXCEPTION
      WHEN OTHERS THEN
         sp_add_exception(v_exp_code => SQLCODE,
                 v_exp_message => SUBSTR(SQLERRM, 1 , 500),
                 v_exp_operation => 'Update ActualStartTime',
                 v_exp_object => 'bgService');
         return SQLCODE;   
   end;
 
  function fn_Create_UsersInstruct(
  v_subject       users_instruct.subject%type,
  v_content       users_instruct.content%type,
  v_priority      users_instruct.priority%type,
  v_createdbyid   users_instruct.createdbyid%type,
  v_expire_time   users_instruct.expire_time%type,
  v_post_it number
 ) return number is 
  v_ins_id        users_instruct.ins_id%type;
  v_createdbyacc  users_instruct.createdbyacc%type;
  v_tmp number;
 begin
    v_createdbyacc :=  pk_utility.fn_getactiveaccount(v_partner_id => v_createdbyid);
    
    v_ins_id := seq_user_inst_id.nextval();
    insert into users_instruct
  (ins_id,
   createdon,
   content,
   subject,
   priority,
   status,
   status_time,
   createdbyid,
   createdbyacc,
   expire_time)
values
  (v_ins_id,
   sysdate,
   v_content,
   v_subject,
   v_priority,
   'new',
   sysdate,
   v_createdbyid,
   v_createdbyacc,
   v_expire_time);
   
   if (v_post_it = 1) then
     begin
       v_tmp := fn_UserInstruct_post(v_ins_id);
     end;
   end if;
   
  return v_ins_id;
    
       EXCEPTION
      WHEN OTHERS THEN
         sp_add_exception(v_exp_code => SQLCODE,
                 v_exp_message => SUBSTR(SQLERRM, 1 , 500),
                 v_exp_operation => 'Create',
                 v_exp_object => 'UsersInstruct');
         return SQLCODE;   
 end;
 
  function fn_Create_UserInstructTo(
  v_ins_id  users_instruct_to.ins_id%type, 
  v_role_id users_instruct_to.role_id%type
   ) return number is 
   v_to_id   users_instruct_to.to_id%type;
   begin
     select nvl(max(to_id),0) + 1 into v_to_id from users_instruct_to where ins_id = v_ins_id;
     insert into users_instruct_to
       (to_id, ins_id, role_id)
     values
        (v_to_id, v_ins_id, v_role_id);
      return v_to_id;
         EXCEPTION
      WHEN OTHERS THEN
         sp_add_exception(v_exp_code => SQLCODE,
                 v_exp_message => SUBSTR(SQLERRM, 1 , 500),
                 v_exp_operation => 'Create',
                 v_exp_object => 'UserInstructTo');
         return SQLCODE;   
     end;
 function fn_Create_UsersInstruct_his(
  v_ins_id        users_instruct_his.ins_id%type,
     v_subject       users_instruct_his.subject%type,
  v_content       users_instruct_his.content%type,
  v_partner_id  users_instruct_his.partner_id%type,
  v_createdon     users_instruct_his.createdon%type,
  v_priority      users_instruct_his.priority%type,
  v_createdbyid   users_instruct_his.createdbyid%type,
  v_createdbyacc  users_instruct_his.createdbyacc%type,
  v_expire_time   users_instruct_his.expire_time%type 
 ) return number is 
 v_his_id        users_instruct_his.his_id%type;
 v_partner_acc  users_instruct_his.partner_acc%type;
 begin
    v_his_id := seq_users_instruct_his_id.nextval();
    v_partner_acc := pk_utility.fn_getactiveaccount(v_partner_id => v_partner_id);
    insert into users_instruct_his
  (his_id,
   ins_id,
   partner_id,
   partner_acc,
   content,
   subject,
   priority,
   status,
   status_time,
   createdbyid,
   createdbyacc,
   expire_time,
   createdon,
   historyon)
values
  (v_his_id,
   v_ins_id,
   v_partner_id,
   v_partner_acc,
   v_content,
   v_subject,
   v_priority,
   'unread',
   sysdate,
   v_createdbyid,
   v_createdbyacc,
   v_expire_time,
   v_createdon,
   sysdate);
   return v_his_id;
       EXCEPTION
      WHEN OTHERS THEN
         sp_add_exception(v_exp_code => SQLCODE,
                 v_exp_message => SUBSTR(SQLERRM, 1 , 500),
                 v_exp_operation => 'Create',
                 v_exp_object => 'UsersInstruct_his');
         return SQLCODE;   
 end;
 
function fn_read_UserInstructHis(
  v_his_id        users_instruct_his.his_id%type
) return number is
begin
  update users_instruct_his
   set 
       status = 'read',
       status_time = sysdate
 where his_id = v_his_id and status = 'unread';
 return 1;
end;

function fn_UserInstruct_post(
   v_ins_id        users_instruct.ins_id%type
) return number is
 instructTo_row users_instruct_to%rowtype;
 instruct_row users_instruct%rowtype;
 v_partnerId users_instruct_his.partner_id%type;
 v_tmp number;
 cursor c_to is
 select * from users_instruct_to t where t.ins_id = v_ins_id ;
 
 cursor c_partners(role number) is
 select partner_id 
 from partner p ,partner_activity act
 where p.roleid = act.fromroleid
 and p.roleid = role 
 and status = 1 
 and  act.act_id = 'System.Login';
 
begin

 
 select *  into instruct_row from users_instruct t where t.ins_id =  v_ins_id and t.status = 'new';
 if (sql%notfound) then
    return -1;
 end if;
 if (instruct_row.expire_time < sysdate) then
   return -1;
 end if;
   
 open c_to;
 LOOP
        FETCH c_to INTO instructTo_row;
        EXIT WHEN c_to%notfound;
        --------------------------------------------------------------------------------------------
       --   pk_utility.sp_tmp_log('instructTo_row.Role_Id' || instructTo_row.Role_Id, 'c_to loop');
        --------------------------------------------------------------------------------------------
        OPEN c_partners(instructTo_row.Role_Id);
        LOOP
          FETCH c_partners INTO v_partnerId;
          EXIT WHEN c_partners%notfound;
          --------------------------------------------------------------------------------------------
        --  pk_utility.sp_tmp_log('c_partners' || v_partnerId, 'c_partners loop');
        --------------------------------------------------------------------------------------------
             v_tmp :=  pk_infra.fn_create_usersinstruct_his(v_ins_id => instruct_row.ins_id,
                                                  v_subject => instruct_row.subject,
                                                  v_content => instruct_row.content,
                                                  v_partner_id => v_partnerId,
                                                  v_createdon => instruct_row.createdon,
                                                  v_priority => instruct_row.priority,
                                                  v_createdbyid => instruct_row.createdbyid,
                                                  v_createdbyacc => instruct_row.createdbyacc,
                                                  v_expire_time => instruct_row.expire_time);
          --------------------------------------------------------------------------------------------
        --  pk_utility.sp_tmp_log('v_tmp', v_tmp);
        --------------------------------------------------------------------------------------------
        END LOOP;
        close c_partners;
 END LOOP;
 close c_to;
     --------------------------------------------------------------------------------------------
        --  pk_utility.sp_tmp_log('update statue to post', 'post');
        --------------------------------------------------------------------------------------------
   update users_instruct
   set   status = 'post',
       status_time = sysdate
 where ins_id = v_ins_id;
 
 return 1;
 
       EXCEPTION
      WHEN OTHERS THEN
         sp_add_exception(v_exp_code => SQLCODE,
                 v_exp_message => SUBSTR(SQLERRM, 1 , 500),
                 v_exp_operation => 'post',
                 v_exp_object => 'UsersInstruct');
         return SQLCODE;   
end;

function fn_UserInstruct_Delete(
   v_ins_id        users_instruct.ins_id%type
) return number is
 instruct_row users_instruct%rowtype;
begin
   select *  into instruct_row from users_instruct where ins_id =  v_ins_id;
 if (sql%notfound) then
    return -1;
 end if;
  if (instruct_row.status = 'new') then
    begin
        delete from users_instruct where ins_id = v_ins_id;
        return 1;
    end;
 end if;
 return -1;
end;

function fn_UserInstructTo_Delete(
 v_to_id   users_instruct_to.to_id%type
) return number is 

begin
  delete from users_instruct_to where to_id = v_to_id;
  return 1;
end;

function fn_create_api_ip_blacklist(
  v_ip_address api_ip_blacklist.ip_address%type
  ) return number is
  v_tmp number := 0;
 begin
     select nvl(count(*),0) into v_tmp from api_ip_blacklist where ip_address = v_ip_address;
     
     if (v_tmp > 0) then
       begin
           return 2;
       end;
       end if;
       
       insert into api_ip_blacklist
       (ip_address, createdon)
      values
      (v_ip_address, sysdate);

    return 1;
       EXCEPTION
      WHEN OTHERS THEN
         sp_add_exception(v_exp_code => SQLCODE,
                 v_exp_message => SUBSTR(SQLERRM, 1 , 500),
                 v_exp_operation => 'Create',
                 v_exp_object => 'ip_blacklist');
         return SQLCODE;   
 end;

function fn_create_api_log(
  v_log_data api_log.log_data%type,
  v_log_user api_log.log_user%type,
  v_log_ip api_log.log_ip%type,
  v_log_level  api_log.log_level%type,
  v_log_action  api_log.log_action%type
  ) return number is
   v_log_id number;
  begin
     v_log_id := seq_api_log.nextval();
     insert into api_log
         (log_id, createdon, log_data, log_user, log_ip, log_level,log_action)
     values
        (v_log_id, sysdate, v_log_data, v_log_user, v_log_ip, v_log_level,v_log_action);
     return v_log_id;
  EXCEPTION
      WHEN OTHERS THEN
         sp_add_exception(v_exp_code => SQLCODE,
                 v_exp_message => SUBSTR(SQLERRM, 1 , 500),
                 v_exp_operation => 'Create',
                 v_exp_object => 'api_log');
         return SQLCODE;     
  end;

end pk_infra;
/

prompt
prompt Creating package body PK_SETTINGS
prompt =================================
prompt
create or replace package body pk_Settings is

function fn_CreatePartnerActivity (
  v_act_id partner_activity.act_id%type, 
  v_fromroleid partner_activity.fromroleid%type, 
  v_queryduration partner_activity.queryduration%type, 
  v_act_scope partner_activity.act_scope%type, 
  v_maxrec partner_activity.maxrec%type, 
  v_onlypartchildren partner_activity.onlypartchildren%type, 
  v_createdby partner_activity.createdby%type,
   v_createdbyacc partner_activity.createdbyacc%type
  ) return number is
  v_row_id partner_activity.row_id%type;
  BEGIN
     v_row_id := seq_partner_acivity_rowid.nextval();
     insert into partner_activity
       (row_id, act_id, fromroleid, queryduration, act_scope, maxrec, onlypartchildren, createdon, createdby, lastediton, createdbyacc)
    values
       (v_row_id, v_act_id, v_fromroleid, v_queryduration, v_act_scope, v_maxrec, v_onlypartchildren, sysdate, v_createdby, sysdate, v_createdbyacc);
       return v_row_id;
EXCEPTION
      WHEN OTHERS THEN
         sp_add_exception(v_exp_code => SQLCODE,
                 v_exp_message => SUBSTR(SQLERRM, 1 , 500),
                 v_exp_operation => 'Create',
                 v_exp_object => 'Partner Activity');
         return SQLCODE;
  END;
  
  function fn_UpdatePartnerActivity (
    v_row_id partner_activity.row_id%type,
    v_act_id partner_activity.act_id%type, 
    v_fromroleid partner_activity.fromroleid%type, 
    v_queryduration partner_activity.queryduration%type, 
    v_act_scope partner_activity.act_scope%type, 
    v_maxrec partner_activity.maxrec%type, 
    v_onlypartchildren partner_activity.onlypartchildren%type
  ) return number is

  BEGIN
     update partner_activity
   set   act_id = v_act_id,
       fromroleid = v_fromroleid,
       queryduration = v_queryduration,
       act_scope = v_act_scope,
       maxrec = v_maxrec,
       onlypartchildren = v_onlypartchildren,
       lastediton = sysdate
 where row_id = v_row_id;
       return 1;
EXCEPTION
      WHEN OTHERS THEN
         sp_add_exception(v_exp_code => SQLCODE,
                 v_exp_message => SUBSTR(SQLERRM, 1 , 500),
                 v_exp_operation => 'Update',
                 v_exp_object => 'Partner Activity');
         return SQLCODE;
  END;
  
function fn_CreatePartnerActivityDetail (
  v_master_row partner_activity_detail.master_row%type, 
  v_dest_role_id partner_activity_detail.dest_role_id%type, 
  v_check_bal partner_activity_detail.check_bal%type, 
  v_max_value partner_activity_detail.max_value%type, 
  v_min_value partner_activity_detail.min_value%type, 
  v_bonus_per partner_activity_detail.bonus_per%type, 
  v_taxper partner_activity_detail.taxper%type, 
  v_bonus_tax partner_activity_detail.bonus_tax%type,
  v_createdby partner_activity_detail.createdby%type,
  v_createdbyacc partner_activity_detail.createdbyacc%type
  ) return number is
  v_row_id partner_activity.row_id%type;
  BEGIN
     select nvl(max(row_id),0) + 1 into v_row_id from partner_activity_detail where master_row = v_master_row;
     insert into partner_activity_detail
  (row_id, master_row, dest_role_id, check_bal, max_value, min_value, bonus_per, taxper, bonus_tax, createdon, createdby, lastediton, createdbyacc)
values
  (v_row_id, v_master_row, v_dest_role_id, v_check_bal, v_max_value, v_min_value, v_bonus_per, v_taxper, v_bonus_tax, sysdate, v_createdby, sysdate, v_createdbyacc);

       return v_row_id;
EXCEPTION
      WHEN OTHERS THEN
         sp_add_exception(v_exp_code => SQLCODE,
                 v_exp_message => SUBSTR(SQLERRM, 1 , 500),
                 v_exp_operation => 'Create',
                 v_exp_object => 'Partner Activity Detail');
         return SQLCODE;
  END;  

function fn_UpdatePartnerActivityDetail (
  v_row_id partner_activity_detail.row_id%type, 
  v_master_row partner_activity_detail.master_row%type, 
  v_dest_role_id partner_activity_detail.dest_role_id%type, 
  v_check_bal partner_activity_detail.check_bal%type, 
  v_max_value partner_activity_detail.max_value%type, 
  v_min_value partner_activity_detail.min_value%type, 
  v_bonus_per partner_activity_detail.bonus_per%type, 
  v_taxper partner_activity_detail.taxper%type, 
  v_bonus_tax partner_activity_detail.bonus_tax%type,
  v_createdby partner_activity.createdby%type
  ) return number is
  BEGIN  
       update partner_activity_detail
          set
            check_bal = v_check_bal,
            max_value = v_max_value,
            min_value = v_min_value,
            bonus_per = v_bonus_per,
            taxper = v_taxper,
            bonus_tax = v_bonus_tax,
            lastediton = sysdate
          where row_id = v_row_id and master_row = v_master_row;
       return 1;
EXCEPTION
      WHEN OTHERS THEN
         sp_add_exception(v_exp_code => SQLCODE,
                 v_exp_message => SUBSTR(SQLERRM, 1 , 500),
                 v_exp_operation => 'Update',
                 v_exp_object => 'Partner Activity Detail');
         return SQLCODE;
  END;  
  
  
    function fn_Create_Message_Template(
    v_msg_name message_template.msg_name%type, 
    v_msg_text message_template.msg_text%type, 
    v_createdby message_template.createdby%type, 
    v_createdbyacc message_template.createdbyacc%type,
    v_towho message_template.towho%type
    ) return number is
    v_msg_id message_template.msg_id%type;
    begin
        select nvl(max(msg_id), 0) + 1 into v_msg_id from message_template;
        
        insert into message_template
            (msg_id, msg_name, msg_text, createdon, createdby, createdbyacc, towho)
          values
            (v_msg_id, v_msg_name, v_msg_text, sysdate, v_createdby, v_createdbyacc, v_towho);
            return v_msg_id;
     EXCEPTION
      WHEN OTHERS THEN
         sp_add_exception(v_exp_code => SQLCODE,
                 v_exp_message => SUBSTR(SQLERRM, 1 , 500),
                 v_exp_operation => 'Create',
                 v_exp_object => 'Message Template');
         return SQLCODE;
            
    end;
    
     function fn_Update_Message_Template(
    v_msg_id message_template.msg_id%type,
    v_msg_name message_template.msg_name%type, 
    v_msg_text message_template.msg_text%type,
     v_towho message_template.towho%type
    ) return number is
   
    begin
       update message_template
        set   msg_name = v_msg_name,
                msg_text = v_msg_text,
               towho = v_towho,
                lastupdateon = sysdate
        where msg_id = v_msg_id;
        return 1;
     EXCEPTION
      WHEN OTHERS THEN
         sp_add_exception(v_exp_code => SQLCODE,
                 v_exp_message => SUBSTR(SQLERRM, 1 , 500),
                 v_exp_operation => 'Update',
                 v_exp_object => 'Message Template');
         return SQLCODE;
            
    end;
  
  
  function fn_Create_Activity_Message(
      v_act_id Activity_Message.act_id%type, 
      v_msg_id Activity_Message.msg_id%type, 
      v_sending_time Activity_Message.Sending_Time%type, 
      v_createdby Activity_Message.createdby%type, 
      v_createdbyacc Activity_Message.createdbyacc%type,
      v_msg_order Activity_Message.Msg_Order%type
      ) return number is
      
      v_count number := 0;
      v_tmp_order number;
      begin
          select nvl(count(*), 0) into v_count from activity_message where act_id = v_act_id and msg_id = v_msg_id;
            if (v_count > 0) then
                 begin
                     --message := 'Duplicated';
                    return -504;
                 end;
                end if; 
                
           if (v_msg_order <= 0) then
             begin
               select nvl(max(msg_order), 0)+1 into v_tmp_order from activity_message where act_id = v_act_id;
             end;
           else 
             begin
                v_tmp_order := v_msg_order;
             end;
             end if;

              insert into activity_message
                (act_id, msg_id, sending_time, createdon, createdby, createdbyacc, msg_order)
              values
                (v_act_id, v_msg_id, v_sending_time, sysdate, v_createdby, v_createdbyacc,v_tmp_order);

             return 1;
      
      
            EXCEPTION
               WHEN OTHERS THEN
                  sp_add_exception(v_exp_code => SQLCODE,
                     v_exp_message => SUBSTR(SQLERRM, 1 , 500),
                    v_exp_operation => 'Create',
                     v_exp_object => 'Activity Message');
                    return SQLCODE; 
      end;     
      
  function fn_Delete_Activity_Message(
      v_act_id Activity_Message.act_id%type, 
      v_msg_id Activity_Message.msg_id%type)
      return number is
         reorderResult number;
      begin
          delete from activity_message where act_id = v_act_id and msg_id = v_msg_id;
          reorderResult := pk_settings.fn_reorder_activity_message(v_act_id => v_act_id);
          return 1;
      
        EXCEPTION
               WHEN OTHERS THEN
                  sp_add_exception(v_exp_code => SQLCODE,
                     v_exp_message => SUBSTR(SQLERRM, 1 , 500),
                    v_exp_operation => 'Delete',
                     v_exp_object => 'Activity Message');
                    return SQLCODE; 
      end;     
      
      function fn_Reorder_Activity_Message(v_act_id Activity_Message.act_id%type)
      return number is
        CURSOR curMessages is 
                   SELECT * FROM activity_message where act_id = v_act_id order by msg_order; 
        v_ActivityMsgRow activity_message%ROWTYPE;
        v_seq number := 1;
      begin
          
         OPEN curMessages;
         LOOP
            FETCH curMessages into v_ActivityMsgRow;
            EXIT WHEN curMessages%notfound;  
            update activity_message set msg_order = v_seq where act_id = v_ActivityMsgRow.Act_Id and msg_id = v_ActivityMsgRow.Msg_Id;
            v_seq := v_seq + 1 ;
       END LOOP;
       return 1;
      
        EXCEPTION
               WHEN OTHERS THEN
                  sp_add_exception(v_exp_code => SQLCODE,
                     v_exp_message => SUBSTR(SQLERRM, 1 , 500),
                    v_exp_operation => 'Reorder',
                     v_exp_object => 'Activity Message');
                    return SQLCODE; 
      end;     
      
end pk_Settings;
/

prompt
prompt Creating package body PK_UTILITY
prompt ================================
prompt
create or replace package body pk_Utility is

 procedure sp_Create_Audit(
v_partner_id    data_audit.partner_id%type,
v_partner_acc    data_audit.partner_acc%type,
v_act_id        data_audit.act_id%type,
v_action_id     data_audit.action_id%type,
v_note          data_audit.note%type,
v_old_value     data_audit.old_value%type,
v_new_value     data_audit.new_value%type,
v_system_note   data_audit.system_note%type,
v_error         data_audit.error%type,
v_success       data_audit.success%type
) is
begin
 insert into data_audit
  (partner_id, createdon, act_id, action_id, note, old_value, new_value, system_note, error, success)
values
  (v_partner_id, sysdate, v_act_id, v_action_id, v_note, v_old_value, v_new_value, v_system_note, v_error, v_success);
end sp_Create_Audit;

function fn_GetActiveAccount(v_partner_id partner.partner_id%type) 
  return number is
    v_partner_acc partner.partner_acc%type;
  begin
    select partner_acc into v_partner_acc from partner where partner_id = v_partner_id and status < 3;
    return v_partner_acc;
     EXCEPTION
        WHEN NO_DATA_FOUND THEN
          return -1;
  end;
    
function fn_IsPartnerActivityDefined(
  v_act_id activities.act_id%type,
  v_fromRoleId approle.roleid%type,
  v_toRoleId approle.roleid%type) return number is
  v_partnerActivityFound number := 0;
  begin
     select nvl(count(*),0) into v_partnerActivityFound from v_partner_activity_detail 
     where act_id = v_act_id and fromroleid = v_fromRoleId and toroleid = v_toRoleId;
     if (v_partnerActivityFound <> 1) then 
       begin
           return 0 ;
       end;
     end if;
     return 1;
   EXCEPTION
        WHEN OTHERS THEN
          return 0;
  end;


function fn_GetPartnerBalance(v_partner_acc partner.partner_acc%type) return partner.balance%type is 
  v_bal partner.balance%type;
 begin
      select nvl(balance - reserved, 0) into v_bal from partner where partner_acc = v_partner_acc and balance >= 0 and reserved >= 0;
      return v_bal;
  EXCEPTION
        WHEN OTHERS THEN
          return -1;
 end;      



function fn_IsIdlePartner(v_partner_acc partner.partner_acc%type) return number is
  v_count number := 0;
  begin
    
      if (pk_utility.fn_getpartnerbalance(v_partner_acc => v_partner_acc) > 0) then
        return 0;
      end if;
  
      select nvl(count(*), 0) into v_count from money_transfer where part_acc = v_partner_acc or creator_acc = v_partner_acc;
      
      if (v_count > 0) then
        return 0;
      end if;
      
      select nvl(count(*), 0) into v_count from adjustment  where adjustment.dest_acc = v_partner_acc;
        if (v_count > 0) then
        return 0;
      end if;
      
      select nvl(count(*), 0) into v_count from confiscation  where confiscation.partner_acc = v_partner_acc;
        if (v_count > 0) then
        return 0;
      end if;
      
       select nvl(count(*), 0) into v_count from pfinrec  where pfinrec.partner_acc = v_partner_acc;
        if (v_count > 0) then
        return 0;
      end if;
      
      return 1;
      
  end;
    
  
function fn_GetPartnerRole(v_partner_acc partner.partner_acc%type) return partner.roleid%type is 
  v_role partner.roleid%type;
 begin
      select nvl(roleid, 0) into v_role from partner where partner_acc = v_partner_acc;
      return v_role;
  EXCEPTION
        WHEN OTHERS THEN
          return -1;
 end;  
 
 function fn_GetPartnerStatus(v_partner_acc partner.partner_acc%type) return partner.status%type is 
  v_status partner.status%type;
 begin
      select nvl(status, 0) into v_status from partner where partner_acc = v_partner_acc;
      return v_status;
  EXCEPTION
        WHEN OTHERS THEN
          return -1;
 end;  
 
 
 procedure sp_tmp_log(
  v_log tmp_log.log%type,
  v_act  tmp_log.act%type
  ) is
  v_logId number;
  begin
    v_logId := seq_tmp_log_id.nextval();
    insert into tmp_log
  (log_id,log_time, log, act)
values
  (v_logId, sysdate, v_log, v_act);
  end;
end pk_Utility;
/

prompt
prompt Creating trigger TR_CITY_BI
prompt ===========================
prompt
create or replace trigger TR_City_BI
  before insert
  on City 
  for each row
declare
  -- local variables here
begin
  :NEW.CityId := SEQ_City_ID.Nextval();
end TR_City_BI;
/

prompt
prompt Creating trigger TR_DATA_AUDIT_BI
prompt =================================
prompt
create or replace trigger TR_data_audit_BI
  before insert
  on  data_audit
  for each row
declare
  -- local variables here
begin
  :NEW.row_id := seq_data_audit_id.Nextval();
end TR_data_audit_BI;
/

prompt
prompt Creating trigger TR_DISTRICT_BI
prompt ===============================
prompt
create or replace trigger TR_District_BI
  before insert
  on District
  for each row
declare
  -- local variables here
begin
  :NEW.DisId := SEQ_District_ID.Nextval();
end TR_District_BI;
/

prompt
prompt Creating trigger TR_OPERATION_EXCEPTION_BI
prompt ==========================================
prompt
create or replace trigger TR_operation_exception_BI

  before insert
  on operation_exception 
  for each row
declare
  -- local variables here
begin
  :NEW.exp_id := seq_exception_id.Nextval();
end TR_operation_exception_BI;
/

prompt
prompt Creating trigger TR_ROLE_BI
prompt ===========================
prompt
create or replace trigger TR_Role_BI
  before insert
  on AppRole 
  for each row
declare
  -- local variables here
begin
  :NEW.RoleId := SEQ_ROLE_ID.Nextval();
end TR_Role_BI;
/

prompt
prompt Creating trigger TR_SMSOUT_BD
prompt =============================
prompt
create or replace trigger tr_smsout_BD
  before   delete
  on SMS_OUT 
  for each row
declare
  -- local variables here
begin
  insert into sms_out_bak
  (row_id, sender, message, receiver, createdon, backedon)
  values (:old.row_id, :old.sender, :old.message, :old.receiver, :old.createdon, sysdate);
end tr_smsout_AD;
/


spool off
